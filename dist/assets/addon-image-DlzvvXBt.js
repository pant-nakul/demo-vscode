/**
 * Copyright (c) 2014-2024 The xterm.js authors. All rights reserved.
 * @license MIT
 *
 * Copyright (c) 2012-2013, Christopher Jeffrey (MIT License)
 * @license MIT
 *
 * Originally forked from (with the author's permission):
 *   Fabrice Bellard's javascript vt100 for jslinux:
 *   http://bellard.org/jslinux/
 *   Copyright (c) 2011 Fabrice Bellard
 */var tA=Object.create;var Z=Object.defineProperty;var iA=Object.getOwnPropertyDescriptor;var sA=Object.getOwnPropertyNames;var rA=Object.getPrototypeOf;var aA=Object.prototype.hasOwnProperty;var G=(A,e)=>()=>(e||A((e={exports:{}}).exports,e),e.exports);var gA=(A,e,t,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of sA(e))!aA.call(A,s)&&s!==t&&Z(A,s,{get:()=>e[s],enumerable:!(i=iA(e,s))||i.enumerable});return A};var L=(A,e,t)=>(t=A!=null?tA(rA(A)):{},gA(!A||!A.__esModule?Z(t,"default",{value:A,enumerable:true}):t,A));var T=G(A=>{Object.defineProperty(A,"__esModule",{value:true});A.DEFAULT_FOREGROUND=A.DEFAULT_BACKGROUND=A.PALETTE_ANSI_256=A.PALETTE_VT340_GREY=A.PALETTE_VT340_COLOR=A.normalizeHLS=A.normalizeRGB=A.nearestColorIndex=A.fromRGBA8888=A.toRGBA8888=A.alpha=A.blue=A.green=A.red=A.BIG_ENDIAN=void 0;A.BIG_ENDIAN=new Uint8Array(new Uint32Array([4278190080]).buffer)[0]===255;A.BIG_ENDIAN&&console.warn("BE platform detected. This version of node-sixel works only on LE properly.");function e(a){return a&255}A.red=e;function t(a){return a>>>8&255}A.green=t;function i(a){return a>>>16&255}A.blue=i;function s(a){return a>>>24&255}A.alpha=s;function r(a,o,h,C=255){return((C&255)<<24|(h&255)<<16|(o&255)<<8|a&255)>>>0}A.toRGBA8888=r;function n(a){return[a&255,a>>8&255,a>>16&255,a>>>24]}A.fromRGBA8888=n;function g(a,o){let h=e(a),C=t(a),c=i(a),D=Number.MAX_SAFE_INTEGER,m=-1;for(let B=0;B<o.length;++B){let _=h-o[B][0],E=C-o[B][1],f=c-o[B][2],u=_*_+E*E+f*f;if(!u)return B;u<D&&(D=u,m=B)}return m}A.nearestColorIndex=g;function I(a,o,h){return Math.max(a,Math.min(h,o))}function d(a,o,h){return h<0&&(h+=1),h>1&&(h-=1),h*6<1?o+(a-o)*6*h:h*2<1?a:h*3<2?o+(a-o)*(4-h*6):o}function Q(a,o,h){if(!h){let D=Math.round(o*255);return r(D,D,D)}let C=o<.5?o*(1+h):o+h-o*h,c=2*o-C;return r(I(0,255,Math.round(d(C,c,a+1/3)*255)),I(0,255,Math.round(d(C,c,a)*255)),I(0,255,Math.round(d(C,c,a-1/3)*255)))}function l(a,o,h){return(4278190080|Math.round(h/100*255)<<16|Math.round(o/100*255)<<8|Math.round(a/100*255))>>>0}A.normalizeRGB=l;function w(a,o,h){return Q((a+240%360)/360,o/100,h/100)}A.normalizeHLS=w;A.PALETTE_VT340_COLOR=new Uint32Array([l(0,0,0),l(20,20,80),l(80,13,13),l(20,80,20),l(80,20,80),l(20,80,80),l(80,80,20),l(53,53,53),l(26,26,26),l(33,33,60),l(60,26,26),l(33,60,33),l(60,33,60),l(33,60,60),l(60,60,33),l(80,80,80)]);A.PALETTE_VT340_GREY=new Uint32Array([l(0,0,0),l(13,13,13),l(26,26,26),l(40,40,40),l(6,6,6),l(20,20,20),l(33,33,33),l(46,46,46),l(0,0,0),l(13,13,13),l(26,26,26),l(40,40,40),l(6,6,6),l(20,20,20),l(33,33,33),l(46,46,46)]);A.PALETTE_ANSI_256=(()=>{let a=[r(0,0,0),r(205,0,0),r(0,205,0),r(205,205,0),r(0,0,238),r(205,0,205),r(0,250,205),r(229,229,229),r(127,127,127),r(255,0,0),r(0,255,0),r(255,255,0),r(92,92,255),r(255,0,255),r(0,255,255),r(255,255,255)],o=[0,95,135,175,215,255];for(let h=0;h<6;++h)for(let C=0;C<6;++C)for(let c=0;c<6;++c)a.push(r(o[h],o[C],o[c]));for(let h=8;h<=238;h+=10)a.push(r(h,h,h));return new Uint32Array(a)})();A.DEFAULT_BACKGROUND=r(0,0,0,255);A.DEFAULT_FOREGROUND=r(255,255,255,255)});var hA=G(A=>{Object.defineProperty(A,"__esModule",{value:true});A.InWasm=void 0;function e(i){if(typeof Buffer<"u")return Buffer.from(i,"base64");let s=atob(i),r=new Uint8Array(s.length);for(let n=0;n<r.length;++n)r[n]=s.charCodeAt(n);return r}function t(i){if(i.d){let{t:s,s:r,d:n}=i,g,I,d=WebAssembly;return s===2?r?()=>g||(g=e(n)):()=>Promise.resolve(g||(g=e(n))):s===1?r?()=>I||(I=new d.Module(g||(g=e(n)))):()=>I?Promise.resolve(I):d.compile(g||(g=e(n))).then(Q=>I=Q):r?Q=>new d.Instance(I||(I=new d.Module(g||(g=e(n)))),Q):Q=>I?d.instantiate(I,Q):d.instantiate(g||(g=e(n)),Q).then(l=>(I=l.module)&&l.instance)}if(typeof _wasmCtx>"u")throw new Error('must run "inwasm"');_wasmCtx.add(i)}A.InWasm=t});var oA=G(A=>{Object.defineProperty(A,"__esModule",{value:true});var e=hA(),t=(0,e.InWasm)({s:1,t:0,d:"AGFzbQEAAAABBQFgAAF/Ag8BA2VudgZtZW1vcnkCAAEDAwIAAAcNAgNkZWMAAANlbmQAAQqxAwKuAQEFf0GIKCgCAEGgKGohAUGEKCgCACIAQYAoKAIAQQFrQXxxIgJIBEAgAkGgKGohAyAAQaAoaiEAA0AgAC0AA0ECdCgCgCAgAC0AAkECdCgCgBggAC0AAUECdCgCgBAgAC0AAEECdCgCgAhycnIiBEH///8HSwRAQQEPCyABIAQ2AgAgAUEDaiEBIABBBGoiACADSQ0ACwtBhCggAjYCAEGIKCABQaAoazYCAEEAC/4BAQZ/AkBBgCgoAgAiAUGEKCgCACIAa0EFTgRAQQEhAxAADQFBgCgoAgAhAUGEKCgCACEAC0EBIQMgASAAayIEQQJIDQAgAEGhKGotAABBAnQoAoAQIABBoChqLQAAQQJ0KAKACHIhAQJAIARBAkYEQEEBIQIMAQtBASECIAAtAKIoIgVBPUcEQEECIQIgBUECdCgCgBggAXIhAQsgBEEERw0AIAAtAKMoIgBBPUYNACACQQFqIQIgAEECdCgCgCAgAXIhAQsgAUH///8HSw0AQYgoKAIAQaAoaiABNgIAQYgoQYgoKAIAIAJqIgA2AgAgAEGQKCgCAEchAwsgAwsAdglwcm9kdWNlcnMBDHByb2Nlc3NlZC1ieQEFY2xhbmdWMTguMC4wIChodHRwczovL2dpdGh1Yi5jb20vbGx2bS9sbHZtLXByb2plY3QgZDFlNjg1ZGY0NWRjNTk0NGI0M2QyNTQ3ZDAxMzhjZDRhM2VlNGVmZSkALA90YXJnZXRfZmVhdHVyZXMCKw9tdXRhYmxlLWdsb2JhbHMrCHNpZ24tZXh0"}),i=new Uint8Array("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".split("").map(g=>g.charCodeAt(0))),s=new Uint32Array(1024);s.fill(4278190080);for(let g=0;g<i.length;++g)s[i[g]]=g<<2;for(let g=0;g<i.length;++g)s[256+i[g]]=g>>4|(g<<4&255)<<8;for(let g=0;g<i.length;++g)s[512+i[g]]=g>>2<<8|(g<<6&255)<<16;for(let g=0;g<i.length;++g)s[768+i[g]]=g<<16;var r=new Uint8Array(0),n=class{constructor(g){this.keepSize=g}get data8(){return this._inst?this._d.subarray(0,this._m32[1282]):r}release(){this._inst&&(this._mem.buffer.byteLength>this.keepSize?this._inst=this._m32=this._d=this._mem=null:(this._m32[1280]=0,this._m32[1281]=0,this._m32[1282]=0))}init(g){let I=this._m32,d=(Math.ceil(g/3)+1288)*4;this._inst?this._mem.buffer.byteLength<d&&(this._mem.grow(Math.ceil((d-this._mem.buffer.byteLength)/65536)),I=new Uint32Array(this._mem.buffer,0),this._d=new Uint8Array(this._mem.buffer,1288*4)):(this._mem=new WebAssembly.Memory({initial:Math.ceil(d/65536)}),this._inst=t({env:{memory:this._mem}}),I=new Uint32Array(this._mem.buffer,0),I.set(s,256),this._d=new Uint8Array(this._mem.buffer,1288*4)),I[1284]=g,I[1283]=Math.ceil(g/3)*4,I[1280]=0,I[1281]=0,I[1282]=0,this._m32=I}put(g,I,d){if(!this._inst)return 1;let Q=this._m32;return d-I+Q[1280]>Q[1283]?1:(this._d.set(g.subarray(I,d),Q[1280]),Q[1280]+=d-I,Q[1280]-Q[1281]>=131072?this._inst.exports.dec():0)}end(){return this._inst?this._inst.exports.end():1}};A.default=n});var nA=G(A=>{Object.defineProperty(A,"__esModule",{value:true});A.LIMITS=void 0;A.LIMITS={CHUNK_SIZE:16384,PALETTE_SIZE:4096,MAX_WIDTH:16384,BYTES:"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AEHAiwIgADcDAEG4iwIgADcDAEGwiwIgADcDAEGoiwIgADcDAEGgiwIgADcDAEGYiwIgADcDAEGQiwIgADcDAEGIiwIgADcDAEGAiwIgADcDAEH4igIgADcDAEHwigIgADcDAEHoigIgADcDAEHgigIgADcDAEHYigIgADcDAEHQigIgADcDAEHIigIgADcDAEHAigIgADcDAEG4igIgADcDAEGwigIgADcDAEGoigIgADcDAEGgigIgADcDAEGYigIgADcDAEGQigIgADcDAEGIigIgADcDAEGAigIgADcDAEH4iQIgADcDAEHwiQIgADcDAEHoiQIgADcDAEHgiQIgADcDAEHYiQIgADcDAEHQiQIgADcDAEHIiQIgADcDAEHAiQIgADcDAEG4iQIgADcDAEGwiQIgADcDAEGoCCgCACIEQf8AakGAAW0hCAJAIARBgQFIDQBBASEBIAhBAiAIQQJKG0EBayICQQFxIQMgBEGBAk4EQCACQX5xIQIDQCABQQl0IgdBEHJBoIkCakGwiQJBgAT8CgAAIAdBsI0CakGwiQJBgAT8CgAAIAFBAmohASACQQJrIgINAAsLIANFDQAgAUEJdEEQckGgiQJqQbCJAkGABPwKAAALAkAgBEEBSA0AIAhBASAIQQFKGyIDQQFxIQUCQCADQQFrIgdFBEBBACEBDAELIANB/v///wdxIQJBACEBA0AgAUEJdCIGQRByQbCJBmpBsIkCQYAE/AoAACAGQZAEckGwiQZqQbCJAkGABPwKAAAgAUECaiEBIAJBAmsiAg0ACwsgBQRAIAFBCXRBEHJBsIkGakGwiQJBgAT8CgAACyAEQQFIDQAgA0EBcSEFIAcEfyADQf7///8HcSECQQAhAQNAIAFBCXQiBkEQckHAiQpqQbCJAkGABPwKAAAgBkGQBHJBwIkKakGwiQJBgAT8CgAAIAFBAmohASACQQJrIgINAAsgAUEHdEEEcgVBBAshASAFBEAgAUECdEHAiQpqQbCJAkGABPwKAAALIARBAUgNACADQQFxIQUgBwR/IANB/v///wdxIQJBACEBA0AgAUEJdCIGQRByQdCJDmpBsIkCQYAE/AoAACAGQZAEckHQiQ5qQbCJAkGABPwKAAAgAUECaiEBIAJBAmsiAg0ACyABQQd0QQRyBUEECyEBIAUEQCABQQJ0QdCJ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"}});var IA=G(A=>{Object.defineProperty(A,"__esModule",{value:true});A.decodeAsync=A.decode=A.Decoder=A.DecoderAsync=void 0;var e=T(),t=nA();function i(a){if(typeof Buffer<"u")return Buffer.from(a,"base64");let o=atob(a),h=new Uint8Array(o.length);for(let C=0;C<h.length;++C)h[C]=o.charCodeAt(C);return h}var s=i(t.LIMITS.BYTES),r,n=new Uint32Array,g=class{constructor(){this.bandHandler=a=>1,this.modeHandler=a=>1}handle_band(a){return this.bandHandler(a)}mode_parsed(a){return this.modeHandler(a)}},I={memoryLimit:2048*65536,sixelColor:e.DEFAULT_FOREGROUND,fillColor:e.DEFAULT_BACKGROUND,palette:e.PALETTE_VT340_COLOR,paletteLimit:t.LIMITS.PALETTE_SIZE,truncate:true};function d(a){let o=new g,h={env:{handle_band:o.handle_band.bind(o),mode_parsed:o.mode_parsed.bind(o)}};return WebAssembly.instantiate(r||s,h).then(C=>(r=r||C.module,new Q(a,C.instance||C,o)))}A.DecoderAsync=d;var Q=class{constructor(a,o,h){if(this._PIXEL_OFFSET=t.LIMITS.MAX_WIDTH+4,this._canvas=n,this._bandWidths=[],this._maxWidth=0,this._minWidth=t.LIMITS.MAX_WIDTH,this._lastOffset=0,this._currentHeight=0,this._opts=Object.assign({},I,a),this._opts.paletteLimit>t.LIMITS.PALETTE_SIZE)throw new Error(`DecoderOptions.paletteLimit must not exceed ${t.LIMITS.PALETTE_SIZE}`);if(o)h.bandHandler=this._handle_band.bind(this),h.modeHandler=this._initCanvas.bind(this);else{let C=r||(r=new WebAssembly.Module(s));o=new WebAssembly.Instance(C,{env:{handle_band:this._handle_band.bind(this),mode_parsed:this._initCanvas.bind(this)}})}this._instance=o,this._wasm=this._instance.exports,this._chunk=new Uint8Array(this._wasm.memory.buffer,this._wasm.get_chunk_address(),t.LIMITS.CHUNK_SIZE),this._states=new Uint32Array(this._wasm.memory.buffer,this._wasm.get_state_address(),12),this._palette=new Uint32Array(this._wasm.memory.buffer,this._wasm.get_palette_address(),t.LIMITS.PALETTE_SIZE),this._palette.set(this._opts.palette),this._pSrc=new Uint32Array(this._wasm.memory.buffer,this._wasm.get_p0_address()),this._wasm.init(e.DEFAULT_FOREGROUND,0,this._opts.paletteLimit,0)}get _fillColor(){return this._states[0]}get _truncate(){return this._states[8]}get _rasterWidth(){return this._states[6]}get _rasterHeight(){return this._states[7]}get _width(){return this._states[2]?this._states[2]-4:0}get _height(){return this._states[3]}get _level(){return this._states[9]}get _mode(){return this._states[10]}get _paletteLimit(){return this._states[11]}_initCanvas(a){if(a===2){let o=this.width*this.height;if(o>this._canvas.length){if(this._opts.memoryLimit&&o*4>this._opts.memoryLimit)throw this.release(),new Error("image exceeds memory limit");this._canvas=new Uint32Array(o)}this._maxWidth=this._width}else if(a===1)if(this._level===2){let o=Math.min(this._rasterWidth,t.LIMITS.MAX_WIDTH)*this._rasterHeight;if(o>this._canvas.length){if(this._opts.memoryLimit&&o*4>this._opts.memoryLimit)throw this.release(),new Error("image exceeds memory limit");this._canvas=new Uint32Array(o)}}else this._canvas.length<65536&&(this._canvas=new Uint32Array(65536));return 0}_realloc(a,o){let h=a+o;if(h>this._canvas.length){if(this._opts.memoryLimit&&h*4>this._opts.memoryLimit)throw this.release(),new Error("image exceeds memory limit");let C=new Uint32Array(Math.ceil(h/65536)*65536);C.set(this._canvas),this._canvas=C}}_handle_band(a){let o=this._PIXEL_OFFSET,h=this._lastOffset;if(this._mode===2){let C=this.height-this._currentHeight,c=0;for(;c<6&&C>0;)this._canvas.set(this._pSrc.subarray(o*c,o*c+a),h+a*c),c++,C--;this._lastOffset+=a*c,this._currentHeight+=c}else if(this._mode===1){this._realloc(h,a*6),this._maxWidth=Math.max(this._maxWidth,a),this._minWidth=Math.min(this._minWidth,a);for(let C=0;C<6;++C)this._canvas.set(this._pSrc.subarray(o*C,o*C+a),h+a*C);this._bandWidths.push(a),this._lastOffset+=a*6,this._currentHeight+=6}return 0}get width(){return this._mode!==1?this._width:Math.max(this._maxWidth,this._wasm.current_width())}get height(){return this._mode!==1?this._height:this._wasm.current_width()?this._bandWidths.length*6+this._wasm.current_height():this._bandWidths.length*6}get palette(){return this._palette.subarray(0,this._paletteLimit)}get memoryUsage(){return this._canvas.byteLength+this._wasm.memory.buffer.byteLength+8*this._bandWidths.length}get properties(){return{width:this.width,height:this.height,mode:this._mode,level:this._level,truncate:!!this._truncate,paletteLimit:this._paletteLimit,fillColor:this._fillColor,memUsage:this.memoryUsage,rasterAttributes:{numerator:this._states[4],denominator:this._states[5],width:this._rasterWidth,height:this._rasterHeight}}}init(a=this._opts.fillColor,o=this._opts.palette,h=this._opts.paletteLimit,C=this._opts.truncate){this._wasm.init(this._opts.sixelColor,a,h,C?1:0),o&&this._palette.set(o.subarray(0,t.LIMITS.PALETTE_SIZE)),this._bandWidths.length=0,this._maxWidth=0,this._minWidth=t.LIMITS.MAX_WIDTH,this._lastOffset=0,this._currentHeight=0}decode(a,o=0,h=a.length){let C=o;for(;C<h;){let c=Math.min(h-C,t.LIMITS.CHUNK_SIZE);this._chunk.set(a.subarray(C,C+=c)),this._wasm.decode(0,c)}}decodeString(a,o=0,h=a.length){let C=o;for(;C<h;){let c=Math.min(h-C,t.LIMITS.CHUNK_SIZE);for(let D=0,m=C;D<c;++D,++m)this._chunk[D]=a.charCodeAt(m);C+=c,this._wasm.decode(0,c)}}get data32(){if(this._mode===0||!this.width||!this.height)return n;let a=this._wasm.current_width();if(this._mode===2){let o=this.height-this._currentHeight;if(o>0){let h=this._PIXEL_OFFSET,C=this._lastOffset,c=0;for(;c<6&&o>0;)this._canvas.set(this._pSrc.subarray(h*c,h*c+a),C+a*c),c++,o--;o&&this._canvas.fill(this._fillColor,C+a*c)}return this._canvas.subarray(0,this.width*this.height)}if(this._mode===1){if(this._minWidth===this._maxWidth){let c=false;if(a)if(a!==this._minWidth)c=true;else{let D=this._PIXEL_OFFSET,m=this._lastOffset;this._realloc(m,a*6);for(let B=0;B<6;++B)this._canvas.set(this._pSrc.subarray(D*B,D*B+a),m+a*B)}if(!c)return this._canvas.subarray(0,this.width*this.height)}let o=new Uint32Array(this.width*this.height);o.fill(this._fillColor);let h=0,C=0;for(let c=0;c<this._bandWidths.length;++c){let D=this._bandWidths[c];for(let m=0;m<6;++m)o.set(this._canvas.subarray(C,C+=D),h),h+=this.width}if(a){let c=this._PIXEL_OFFSET,D=this._wasm.current_height();for(let m=0;m<D;++m)o.set(this._pSrc.subarray(c*m,c*m+a),h+this.width*m)}return o}return n}get data8(){return new Uint8ClampedArray(this.data32.buffer,0,this.width*this.height*4)}release(){this._canvas=n,this._bandWidths.length=0,this._maxWidth=0,this._minWidth=t.LIMITS.MAX_WIDTH,this._wasm.init(e.DEFAULT_FOREGROUND,0,this._opts.paletteLimit,0)}};A.Decoder=Q;function l(a,o){let h=new Q(o);return h.init(),typeof a=="string"?h.decodeString(a):h.decode(a),{width:h.width,height:h.height,data32:h.data32,data8:h.data8}}A.decode=l;async function w(a,o){let h=await d(o);return h.init(),typeof a=="string"?h.decodeString(a):h.decode(a),{width:h.width,height:h.height,data32:h.data32,data8:h.data8}}A.decodeAsync=w});var Y=L(T());var lA;(A=>{function e(r){return r<0}A.isLessThan=e;function t(r){return r<=0}A.isLessThanOrEqual=t;function i(r){return r>0}A.isGreaterThan=i;function s(r){return r===0}A.isNeitherLessOrGreaterThan=s,A.greaterThan=1,A.lessThan=-1,A.neitherLessOrGreaterThan=0})(lA||={});function CA(A,e){let t=this,i=false,s;return function(){if(i)return s;if(i=true,e);else s=A.apply(t,arguments);return s}}var j;(A=>{function e(B){return B&&typeof B=="object"&&typeof B[Symbol.iterator]=="function"}A.is=e;let t=Object.freeze([]);function i(){return t}A.empty=i;function*s(B){yield B}A.single=s;function r(B){return e(B)?B:s(B)}A.wrap=r;function n(B){return B||t}A.from=n;function*g(B){for(let _=B.length-1;_>=0;_--)yield B[_]}A.reverse=g;function I(B){return!B||B[Symbol.iterator]().next().done===true}A.isEmpty=I;function d(B){return B[Symbol.iterator]().next().value}A.first=d;function Q(B,_){let E=0;for(let f of B)if(_(f,E++))return true;return false}A.some=Q;function l(B,_){for(let E of B)if(_(E))return E}A.find=l;function*w(B,_){for(let E of B)_(E)&&(yield E)}A.filter=w;function*a(B,_){let E=0;for(let f of B)yield _(f,E++)}A.map=a;function*o(B,_){let E=0;for(let f of B)yield*_(f,E++)}A.flatMap=o;function*h(...B){for(let _ of B)yield*_}A.concat=h;function C(B,_,E){let f=E;for(let u of B)f=_(f,u);return f}A.reduce=C;function*c(B,_,E=B.length){for(_<0&&(_+=B.length),E<0?E+=B.length:E>B.length&&(E=B.length);_<E;_++)yield B[_]}A.slice=c;function D(B,_=Number.POSITIVE_INFINITY){let E=[];if(_===0)return[E,B];let f=B[Symbol.iterator]();for(let u=0;u<_;u++){let K=f.next();if(K.done)return[E,A.empty()];E.push(K.value)}return[E,{[Symbol.iterator](){return f}}]}A.consume=D;async function m(B){let _=[];for await(let E of B)_.push(E);return Promise.resolve(_)}A.asyncToArray=m})(j||={});function BA(A){return A}function X(A,e){}function QA(A){if(j.is(A)){let e=[];for(let t of A)if(t)try{t.dispose()}catch(i){e.push(i)}if(e.length===1)throw e[0];if(e.length>1)throw new AggregateError(e,"Encountered errors while disposing of store");return Array.isArray(A)?[]:A}else if(A)return A.dispose(),A}function cA(A){let e=BA({dispose:CA(()=>{A()})});return e}var V=class ${constructor(){this._toDispose=new Set;this._isDisposed=false}dispose(){this._isDisposed||(this._isDisposed=true,this.clear())}get isDisposed(){return this._isDisposed}clear(){if(this._toDispose.size!==0)try{QA(this._toDispose)}finally{this._toDispose.clear()}}add(e){if(!e)return e;if(e===this)throw new Error("Cannot register a disposable on itself!");return this._isDisposed?$.DISABLE_DISPOSED_WARNING||console.warn(new Error("Trying to add a disposable to a DisposableStore that has already been disposed of. The added object will be leaked!").stack):this._toDispose.add(e),e}delete(e){if(e){if(e===this)throw new Error("Cannot dispose a disposable on itself!");this._toDispose.delete(e),e.dispose()}}deleteAndLeak(e){e&&this._toDispose.has(e)&&(this._toDispose.delete(e),X())}};V.DISABLE_DISPOSED_WARNING=false;var dA=V;var AA=class{constructor(){this._store=new dA;X(this._store)}dispose(){this._store.dispose()}_register(A){if(A===this)throw new Error("Cannot register a disposable on itself!");return this._store.add(A)}};AA.None=Object.freeze({dispose(){}});var _A=class{constructor(){this._isDisposed=false}get value(){return this._isDisposed?void 0:this._value}set value(A){this._isDisposed||A===this._value||(this._value?.dispose(),this._value=A)}clear(){this.value=void 0}dispose(){this._isDisposed=true,this._value?.dispose(),this._value=void 0}clearAndLeak(){let A=this._value;return this._value=void 0,A}};var EA=4096;var F=24;var S=class p extends AA{constructor(e){super();this._terminal=e;this._optionsRefresh=this._register(new _A);this._oldOpen=this._terminal._core.open,this._terminal._core.open=t=>{this._oldOpen?.call(this._terminal._core,t),this._open()},this._terminal._core.screenElement&&this._open(),this._optionsRefresh.value=this._terminal._core.optionsService.onOptionChange(t=>{t==="fontSize"&&(this.rescaleCanvas(),this._renderService?.refreshRows(0,this._terminal.rows))}),this._register(cA(()=>{this.removeLayerFromDom(),this._terminal._core&&this._oldOpen&&(this._terminal._core.open=this._oldOpen,this._oldOpen=void 0),this._renderService&&this._oldSetRenderer&&(this._renderService.setRenderer=this._oldSetRenderer,this._oldSetRenderer=void 0),this._renderService=void 0,this.canvas=void 0,this._ctx=void 0,this._placeholderBitmap?.close(),this._placeholderBitmap=void 0,this._placeholder=void 0}))}static createCanvas(e,t,i){let s=(e||document).createElement("canvas");return s.width=t|0,s.height=i|0,s}static createImageData(e,t,i,s){if(typeof ImageData!="function"){let r=e.createImageData(t,i);return s&&r.data.set(new Uint8ClampedArray(s,0,t*i*4)),r}return s?new ImageData(new Uint8ClampedArray(s,0,t*i*4),t,i):new ImageData(t,i)}static createImageBitmap(e){return typeof createImageBitmap!="function"?Promise.resolve(void 0):createImageBitmap(e)}showPlaceholder(e){e?!this._placeholder&&this.cellSize.height!==-1&&this._createPlaceHolder(Math.max(this.cellSize.height+1,F)):(this._placeholderBitmap?.close(),this._placeholderBitmap=void 0,this._placeholder=void 0),this._renderService?.refreshRows(0,this._terminal.rows)}get dimensions(){return this._renderService?.dimensions}get cellSize(){return{width:this.dimensions?.css.cell.width||-1,height:this.dimensions?.css.cell.height||-1}}clearLines(e,t){this._ctx?.clearRect(0,e*(this.dimensions?.css.cell.height||0),this.dimensions?.css.canvas.width||0,(++t-e)*(this.dimensions?.css.cell.height||0))}clearAll(){this._ctx?.clearRect(0,0,this.canvas?.width||0,this.canvas?.height||0)}draw(e,t,i,s,r=1){if(!this._ctx)return;let{width:n,height:g}=this.cellSize;if(n===-1||g===-1)return;this._rescaleImage(e,n,g);let I=e.actual,d=Math.ceil(I.width/n),Q=t%d*n,l=Math.floor(t/d)*g,w=i*n,a=s*g,o=r*n+Q>I.width?I.width-Q:r*n,h=l+g>I.height?I.height-l:g;this._ctx.drawImage(I,Math.floor(Q),Math.floor(l),Math.ceil(o),Math.ceil(h),Math.floor(w),Math.floor(a),Math.ceil(o),Math.ceil(h))}extractTile(e,t){let{width:i,height:s}=this.cellSize;if(i===-1||s===-1)return;this._rescaleImage(e,i,s);let r=e.actual,n=Math.ceil(r.width/i),g=t%n*i,I=Math.floor(t/n)*s,d=i+g>r.width?r.width-g:i,Q=I+s>r.height?r.height-I:s,l=p.createCanvas(this.document,d,Q),w=l.getContext("2d");if(w)return w.drawImage(r,Math.floor(g),Math.floor(I),Math.floor(d),Math.floor(Q),0,0,Math.floor(d),Math.floor(Q)),l}drawPlaceholder(e,t,i=1){if(this._ctx){let{width:s,height:r}=this.cellSize;if(s===-1||r===-1||(this._placeholder?r>=this._placeholder.height&&this._createPlaceHolder(r+1):this._createPlaceHolder(Math.max(r+1,F)),!this._placeholder))return;this._ctx.drawImage(this._placeholderBitmap||this._placeholder,e*s,t*r%2?0:1,s*i,r,e*s,t*r,s*i,r)}}rescaleCanvas(){this.canvas&&(this.canvas.width!==this.dimensions.css.canvas.width||this.canvas.height!==this.dimensions.css.canvas.height)&&(this.canvas.width=this.dimensions.css.canvas.width||0,this.canvas.height=this.dimensions.css.canvas.height||0)}_rescaleImage(e,t,i){if(t===e.actualCellSize.width&&i===e.actualCellSize.height)return;let{width:s,height:r}=e.origCellSize;if(t===s&&i===r){e.actual=e.orig,e.actualCellSize.width=s,e.actualCellSize.height=r;return}let n=p.createCanvas(this.document,Math.ceil(e.orig.width*t/s),Math.ceil(e.orig.height*i/r)),g=n.getContext("2d");g&&(g.drawImage(e.orig,0,0,n.width,n.height),e.actual=n,e.actualCellSize.width=t,e.actualCellSize.height=i)}_open(){this._renderService=this._terminal._core._renderService,this._oldSetRenderer=this._renderService.setRenderer.bind(this._renderService),this._renderService.setRenderer=e=>{this.removeLayerFromDom(),this._oldSetRenderer?.call(this._renderService,e)}}insertLayerToDom(){this.document&&this._terminal._core.screenElement?this.canvas||(this.canvas=p.createCanvas(this.document,this.dimensions?.css.canvas.width||0,this.dimensions?.css.canvas.height||0),this.canvas.classList.add("xterm-image-layer"),this._terminal._core.screenElement.appendChild(this.canvas),this._ctx=this.canvas.getContext("2d",{alpha:true,desynchronized:true}),this.clearAll()):console.warn("image addon: cannot insert output canvas to DOM, missing document or screenElement")}removeLayerFromDom(){this.canvas&&(this._ctx=void 0,this.canvas.remove(),this.canvas=void 0)}_createPlaceHolder(e=F){this._placeholderBitmap?.close(),this._placeholderBitmap=void 0;let t=32,i=p.createCanvas(this.document,t,e),s=i.getContext("2d",{alpha:false});if(!s)return;let r=p.createImageData(s,t,e),n=new Uint32Array(r.data.buffer),g=(0,Y.toRGBA8888)(0,0,0),I=(0,Y.toRGBA8888)(255,255,255);n.fill(g);for(let l=0;l<e;++l){let w=l%2,a=l*t;for(let o=0;o<t;o+=2)n[a+o+w]=I}s.putImageData(r,0,0);let d=screen.width+t-1&~(t-1)||EA;this._placeholder=p.createCanvas(this.document,d,e);let Q=this._placeholder.getContext("2d",{alpha:false});if(!Q){this._placeholder=void 0;return}for(let l=0;l<d;l+=t)Q.drawImage(i,l,0);p.createImageBitmap(this._placeholder).then(l=>this._placeholderBitmap=l)}get document(){return this._terminal._core._coreBrowserService?.window.document}};var M={width:7,height:14};var x=class eA{constructor(e=0,t=0,i=-1,s=-1){this.imageId=i;this.tileId=s;this._ext=0;this._urlId=0;this._ext=e,this._urlId=t}get ext(){return this._urlId?this._ext&-469762049|this.underlineStyle<<26:this._ext}set ext(e){this._ext=e}get underlineStyle(){return this._urlId?5:(this._ext&469762048)>>26}set underlineStyle(e){this._ext&=-469762049,this._ext|=e<<26&469762048}get underlineColor(){return this._ext&67108863}set underlineColor(e){this._ext&=-67108864,this._ext|=e&67108863}get underlineVariantOffset(){let e=(this._ext&3758096384)>>29;return e<0?e^4294967288:e}set underlineVariantOffset(e){this._ext&=536870911,this._ext|=e<<29&3758096384}get urlId(){return this._urlId}set urlId(e){this._urlId=e}clone(){return new eA(this._ext,this._urlId,this.imageId,this.tileId)}isEmpty(){return this.underlineStyle===0&&this._urlId===0&&this.imageId===-1}};var k=new x;var wA=class{constructor(A,e,t){this._terminal=A;this._renderer=e;this._opts=t;this._images=new Map;this._lastId=0;this._lowestId=0;this._fullyCleared=false;this._needsFullClear=false;this._pixelLimit=25e5;try{this.setLimit(this._opts.storageLimit)}catch(i){console.error(i.message),console.warn(`storageLimit is set to ${this.getLimit()} MB`)}this._viewportMetrics={cols:this._terminal.cols,rows:this._terminal.rows}}dispose(){this.reset()}reset(){for(let A of this._images.values())A.marker?.dispose();this._images.clear(),this._renderer.clearAll()}getLimit(){return this._pixelLimit*4/1e6}setLimit(A){if(A<.5||A>1e3)throw RangeError("invalid storageLimit, should be at least 0.5 MB and not exceed 1G");this._pixelLimit=A/4*1e6>>>0,this._evictOldest(0)}getUsage(){return this._getStoredPixels()*4/1e6}_getStoredPixels(){let A=0;for(let e of this._images.values())e.orig&&(A+=e.orig.width*e.orig.height,e.actual&&e.actual!==e.orig&&(A+=e.actual.width*e.actual.height));return A}_delImg(A){let e=this._images.get(A);this._images.delete(A),e&&window.ImageBitmap&&e.orig instanceof ImageBitmap&&e.orig.close()}wipeAlternate(){let A=[];for(let[e,t]of this._images.entries())t.bufferType==="alternate"&&(t.marker?.dispose(),A.push(e));for(let e of A)this._delImg(e);this._needsFullClear=true,this._fullyCleared=false}advanceCursor(A){if(this._opts.sixelScrolling){let e=this._renderer.cellSize;(e.width===-1||e.height===-1)&&(e=M);let t=Math.ceil(A/e.height);for(let i=1;i<t;++i)this._terminal._core._inputHandler.lineFeed()}}addImage(A){this._evictOldest(A.width*A.height);let e=this._renderer.cellSize;(e.width===-1||e.height===-1)&&(e=M);let t=Math.ceil(A.width/e.width),i=Math.ceil(A.height/e.height),s=++this._lastId,r=this._terminal._core.buffer,n=this._terminal.cols,g=this._terminal.rows,I=r.x,d=r.y,Q=I,l=0;this._opts.sixelScrolling||(r.x=0,r.y=0,Q=0),this._terminal._core._inputHandler._dirtyRowTracker.markDirty(r.y);for(let h=0;h<i;++h){let C=r.lines.get(r.y+r.ybase);for(let c=0;c<t&&!(Q+c>=n);++c)this._writeToCell(C,Q+c,s,h*t+c),l++;if(this._opts.sixelScrolling)h<i-1&&this._terminal._core._inputHandler.lineFeed();else if(++r.y>=g)break;r.x=Q}this._terminal._core._inputHandler._dirtyRowTracker.markDirty(r.y),this._opts.sixelScrolling?r.x=Q:(r.x=I,r.y=d);let w=[];for(let[h,C]of this._images.entries())C.tileCount<1&&(C.marker?.dispose(),w.push(h));for(let h of w)this._delImg(h);let a=this._terminal.registerMarker(0);a?.onDispose(()=>{this._images.get(s)&&this._delImg(s)}),this._terminal.buffer.active.type==="alternate"&&this._evictOnAlternate();let o={orig:A,origCellSize:e,actual:A,actualCellSize:{...e},marker:a||void 0,tileCount:l,bufferType:this._terminal.buffer.active.type};this._images.set(s,o)}render(A){if(!this._renderer.canvas&&this._images.size&&(this._renderer.insertLayerToDom(),!this._renderer.canvas))return;if(this._renderer.rescaleCanvas(),!this._images.size){this._fullyCleared||(this._renderer.clearAll(),this._fullyCleared=true,this._needsFullClear=false),this._renderer.canvas&&this._renderer.removeLayerFromDom();return}this._needsFullClear&&(this._renderer.clearAll(),this._fullyCleared=true,this._needsFullClear=false);let{start:e,end:t}=A,i=this._terminal._core.buffer,s=this._terminal._core.cols;this._renderer.clearLines(e,t);for(let r=e;r<=t;++r){let n=i.lines.get(r+i.ydisp);if(!n)return;for(let g=0;g<s;++g)if(n.getBg(g)&268435456){let I=n._extendedAttrs[g]||k,d=I.imageId;if(d===void 0||d===-1)continue;let Q=this._images.get(d);if(I.tileId!==-1){let l=I.tileId,w=g,a=1;for(;++g<s&&n.getBg(g)&268435456&&(I=n._extendedAttrs[g]||k)&&I.imageId===d&&I.tileId===l+a;)a++;g--,Q?Q.actual&&this._renderer.draw(Q,l,w,r,a):this._opts.showPlaceholder&&this._renderer.drawPlaceholder(w,r,a),this._fullyCleared=false}}}}viewportResize(A){if(!this._images.size){this._viewportMetrics=A;return}if(this._viewportMetrics.cols>=A.cols){this._viewportMetrics=A;return}let e=this._terminal._core.buffer,t=e.lines.length,i=this._viewportMetrics.cols-1;for(let s=0;s<t;++s){let r=e.lines.get(s);if(r.getBg(i)&268435456){let n=r._extendedAttrs[i]||k,g=n.imageId;if(g===void 0||g===-1)continue;let I=this._images.get(g);if(!I)continue;let d=Math.ceil((I.actual?.width||0)/I.actualCellSize.width);if(n.tileId%d+1>=d)continue;let Q=false;for(let a=i+1;a>A.cols;++a)if(r._data[a*3+0]&4194303){Q=true;break}if(Q)continue;let l=Math.min(A.cols,d-n.tileId%d+i),w=n.tileId;for(let a=i+1;a<l;++a)this._writeToCell(r,a,g,++w),I.tileCount++}}this._viewportMetrics=A}getImageAtBufferCell(A,e){let t=this._terminal._core.buffer.lines.get(e);if(t&&t.getBg(A)&268435456){let i=t._extendedAttrs[A]||k;if(i.imageId&&i.imageId!==-1){let s=this._images.get(i.imageId)?.orig;if(window.ImageBitmap&&s instanceof ImageBitmap){let r=S.createCanvas(window.document,s.width,s.height);return r.getContext("2d")?.drawImage(s,0,0,s.width,s.height),r}return s}}}extractTileAtBufferCell(A,e){let t=this._terminal._core.buffer.lines.get(e);if(t&&t.getBg(A)&268435456){let i=t._extendedAttrs[A]||k;if(i.imageId&&i.imageId!==-1&&i.tileId!==-1){let s=this._images.get(i.imageId);if(s)return this._renderer.extractTile(s,i.tileId)}}}_evictOldest(A){let e=this._getStoredPixels(),t=e;for(;this._pixelLimit<t+A&&this._images.size;){let i=this._images.get(++this._lowestId);i&&i.orig&&(t-=i.orig.width*i.orig.height,i.actual&&i.orig!==i.actual&&(t-=i.actual.width*i.actual.height),i.marker?.dispose(),this._delImg(this._lowestId))}return e-t}_writeToCell(A,e,t,i){if(A._data[e*3+2]&268435456){let s=A._extendedAttrs[e];if(s){if(s.imageId!==void 0){let r=this._images.get(s.imageId);r&&r.tileCount--,s.imageId=t,s.tileId=i;return}A._extendedAttrs[e]=new x(s.ext,s.urlId,t,i);return}}A._data[e*3+2]|=268435456,A._extendedAttrs[e]=new x(0,0,t,i)}_evictOnAlternate(){for(let t of this._images.values())t.bufferType==="alternate"&&(t.tileCount=0);let A=this._terminal._core.buffer;for(let t=0;t<this._terminal.rows;++t){let i=A.lines.get(t);if(i){for(let s=0;s<this._terminal.cols;++s)if(i._data[s*3+2]&268435456){let r=i._extendedAttrs[s]?.imageId;if(r){let n=this._images.get(r);n&&n.tileCount++}}}}let e=[];for(let[t,i]of this._images.entries())i.bufferType==="alternate"&&!i.tileCount&&(i.marker?.dispose(),e.push(t));for(let t of e)this._delImg(t)}};var DA=L(oA());function J(A){let e="";for(let t=0;t<A.length;++t)e+=String.fromCharCode(A[t]);return e}function R(A){let e=0;for(let t=0;t<A.length;++t){if(A[t]<48||A[t]>57)throw new Error("illegal char");e=e*10+A[t]-48}return e}function W(A){let e=J(A);if(!e.match(/^((auto)|(\d+?((px)|(%)){0,1}))$/))throw new Error("illegal size");return e}function mA(A){if(typeof Buffer<"u")return Buffer.from(J(A),"base64").toString();let e=atob(J(A)),t=new Uint8Array(e.length);for(let i=0;i<t.length;++i)t[i]=e.charCodeAt(i);return new TextDecoder().decode(t)}var q={inline:R,size:R,name:mA,width:W,height:W,preserveAspectRatio:R};var P=[70,105,108,101];var b=1024;var fA=class{constructor(){this.state=0;this._buffer=new Uint32Array(b);this._position=0;this._key="";this.fields={}}reset(){this._buffer.fill(0),this.state=0,this._position=0,this.fields={},this._key=""}parse(A,e,t){let i=this.state,s=this._position,r=this._buffer;if(i===1||i===4||i===0&&s>6)return-1;for(let n=e;n<t;++n){let g=A[n];switch(g){case 59:if(!this._storeValue(s))return this._a();i=2,s=0;break;case 61:if(i===0){for(let I=0;I<P.length;++I)if(r[I]!==P[I])return this._a();i=2,s=0}else if(i===2){if(!this._storeKey(s))return this._a();i=3,s=0}else if(i===3){if(s>=b)return this._a();r[s++]=g}break;case 58:return i===3&&!this._storeValue(s)?this._a():(this.state=4,n+1);default:if(s>=b)return this._a();r[s++]=g}}return this.state=i,this._position=s,-2}_a(){return this.state=1,-1}_storeKey(A){let e=J(this._buffer.subarray(0,A));return e?(this._key=e,this.fields[e]=null,true):false}_storeValue(A){if(this._key){try{let e=this._buffer.slice(0,A);this.fields[this._key]=q[this._key]?q[this._key](e):e}catch{return false}return true}return false}};var H={mime:"unsupported",width:0,height:0};function uA(A){if(A.length<24)return H;let e=new Uint32Array(A.buffer,A.byteOffset,6);if(e[0]===1196314761&&e[1]===169478669&&e[3]===1380206665)return{mime:"image/png",width:A[16]<<24|A[17]<<16|A[18]<<8|A[19],height:A[20]<<24|A[21]<<16|A[22]<<8|A[23]};if(A[0]===255&&A[1]===216&&A[2]===255){let[t,i]=pA(A);return{mime:"image/jpeg",width:t,height:i}}return e[0]===944130375&&(A[4]===55||A[4]===57)&&A[5]===97?{mime:"image/gif",width:A[7]<<8|A[6],height:A[9]<<8|A[8]}:H}function pA(A){let e=A.length,t=4,i=A[t]<<8|A[t+1];for(;;){if(t+=i,t>=e)return[0,0];if(A[t]!==255)return[0,0];if(A[t+1]===192||A[t+1]===194)return t+8<e?[A[t+7]<<8|A[t+8],A[t+5]<<8|A[t+6]]:[0,0];t+=2,i=A[t]<<8|A[t+1]}}var kA=4194304;var v={name:"Unnamed file",size:0,width:"auto",height:"auto",preserveAspectRatio:1,inline:0};var MA=class{constructor(A,e,t,i){this._opts=A;this._renderer=e;this._storage=t;this._coreTerminal=i;this._aborted=false;this._hp=new fA;this._header=v;this._dec=new DA.default(kA);this._metrics=H}reset(){}start(){this._aborted=false,this._header=v,this._metrics=H,this._hp.reset()}put(A,e,t){if(!this._aborted)if(this._hp.state===4)this._dec.put(A,e,t)&&(this._dec.release(),this._aborted=true);else{let i=this._hp.parse(A,e,t);if(i===-1){this._aborted=true;return}if(i>0){if(this._header=Object.assign({},v,this._hp.fields),!this._header.inline||!this._header.size||this._header.size>this._opts.iipSizeLimit){this._aborted=true;return}this._dec.init(this._header.size),this._dec.put(A,i,t)&&(this._dec.release(),this._aborted=true)}}}end(A){if(this._aborted)return true;let e=0,t=0,i=true;if((i=A)&&(i=!this._dec.end())&&(this._metrics=uA(this._dec.data8),(i=this._metrics.mime!=="unsupported")&&(e=this._metrics.width,t=this._metrics.height,(i=e&&t&&e*t<this._opts.pixelLimit)&&([e,t]=this._resize(e,t).map(Math.floor),i=e&&t&&e*t<this._opts.pixelLimit))),!i)return this._dec.release(),true;let s=new Blob([this._dec.data8],{type:this._metrics.mime});if(this._dec.release(),!window.createImageBitmap){let r=URL.createObjectURL(s),n=new Image;return new Promise(g=>{n.addEventListener("load",()=>{URL.revokeObjectURL(r);let I=S.createCanvas(window.document,e,t);I.getContext("2d")?.drawImage(n,0,0,e,t),this._storage.addImage(I),g(true)}),n.src=r,setTimeout(()=>g(true),1e3)})}return createImageBitmap(s,{resizeWidth:e,resizeHeight:t}).then(r=>(this._storage.addImage(r),true))}_resize(A,e){let t=this._renderer.dimensions?.css.cell.width||M.width,i=this._renderer.dimensions?.css.cell.height||M.height,s=this._renderer.dimensions?.css.canvas.width||t*this._coreTerminal.cols,r=this._renderer.dimensions?.css.canvas.height||i*this._coreTerminal.rows,n=this._dim(this._header.width,s,t),g=this._dim(this._header.height,r,i);if(!n&&!g){let I=s/A,d=(r-i)/e,Q=Math.min(I,d);return Q<1?[A*Q,e*Q]:[A,e]}return n?this._header.preserveAspectRatio||!n||!g?[n,e*n/A]:[n,g]:[A*g/e,g]}_dim(A,e,t){return A==="auto"?0:A.endsWith("%")?parseInt(A.slice(0,-1))*e/100:A.endsWith("px")?parseInt(A.slice(0,-2)):parseInt(A)*t}};var y=L(T());var yA=L(IA());var GA=4194304;var U=y.PALETTE_ANSI_256;U.set(y.PALETTE_VT340_COLOR);var NA=class{constructor(A,e,t){this._opts=A;this._storage=e;this._coreTerminal=t;this._size=0;this._aborted=false;(0,yA.DecoderAsync)({memoryLimit:this._opts.pixelLimit*4,palette:U,paletteLimit:this._opts.sixelPaletteLimit}).then(i=>this._dec=i)}reset(){this._dec&&(this._dec.release(),this._dec._palette.fill(0),this._dec.init(0,U,this._opts.sixelPaletteLimit))}hook(A){if(this._size=0,this._aborted=false,this._dec){let e=A.params[1]===1?0:JA(this._coreTerminal._core._inputHandler._curAttrData,this._coreTerminal._core._themeService?.colors);this._dec.init(e,null,this._opts.sixelPaletteLimit)}}put(A,e,t){if(!(this._aborted||!this._dec)){if(this._size+=t-e,this._size>this._opts.sixelSizeLimit){console.warn("SIXEL: too much data, aborting"),this._aborted=true,this._dec.release();return}try{this._dec.decode(A,e,t)}catch(i){console.warn(`SIXEL: error while decoding image - ${i}`),this._aborted=true,this._dec.release()}}}unhook(A){if(this._aborted||!A||!this._dec)return true;let e=this._dec.width,t=this._dec.height;if(!e||!t)return t&&this._storage.advanceCursor(t),true;let i=S.createCanvas(void 0,e,t);return i.getContext("2d")?.putImageData(new ImageData(this._dec.data8,e,t),0,0),this._dec.memoryUsage>GA&&this._dec.release(),this._storage.addImage(i),true}};function JA(A,e){let t=0;if(!e)return t;if(A.isInverse())if(A.isFgDefault())t=N(e.foreground.rgba);else if(A.isFgRGB()){let i=A.constructor.toColorRGB(A.getFgColor());t=(0,y.toRGBA8888)(...i)}else t=N(e.ansi[A.getFgColor()].rgba);else if(A.isBgDefault())t=N(e.background.rgba);else if(A.isBgRGB()){let i=A.constructor.toColorRGB(A.getBgColor());t=(0,y.toRGBA8888)(...i)}else t=N(e.ansi[A.getBgColor()].rgba);return t}function N(A){return y.BIG_ENDIAN?A:(A&255)<<24|(A>>>8&255)<<16|(A>>>16&255)<<8|A>>>24&255}var O={enableSizeReports:true,pixelLimit:16777216,sixelSupport:true,sixelScrolling:true,sixelPaletteLimit:256,sixelSizeLimit:25e6,storageLimit:128,showPlaceholder:true,iipSupport:true,iipSizeLimit:2e7};var z=4096;var HA=class{constructor(A){this._disposables=[];this._handlers=new Map;this._opts=Object.assign({},O,A),this._defaultOpts=Object.assign({},O,A)}dispose(){for(let A of this._disposables)A.dispose();this._disposables.length=0,this._handlers.clear()}_disposeLater(...A){for(let e of A)this._disposables.push(e)}activate(A){if(this._terminal=A,this._renderer=new S(A),this._storage=new wA(A,this._renderer,this._opts),this._opts.enableSizeReports){let e=A.options.windowOptions||{};e.getWinSizePixels=true,e.getCellSizePixels=true,e.getWinSizeChars=true,A.options.windowOptions=e}if(this._disposeLater(this._renderer,this._storage,A.parser.registerCsiHandler({prefix:"?",final:"h"},e=>this._decset(e)),A.parser.registerCsiHandler({prefix:"?",final:"l"},e=>this._decrst(e)),A.parser.registerCsiHandler({final:"c"},e=>this._da1(e)),A.parser.registerCsiHandler({prefix:"?",final:"S"},e=>this._xtermGraphicsAttributes(e)),A.onRender(e=>this._storage?.render(e)),A.parser.registerCsiHandler({intermediates:"!",final:"p"},()=>this.reset()),A.parser.registerEscHandler({final:"c"},()=>this.reset()),A._core._inputHandler.onRequestReset(()=>this.reset()),A.buffer.onBufferChange(()=>this._storage?.wipeAlternate()),A.onResize(e=>this._storage?.viewportResize(e))),this._opts.sixelSupport){let e=new NA(this._opts,this._storage,A);this._handlers.set("sixel",e),this._disposeLater(A._core._inputHandler._parser.registerDcsHandler({final:"q"},e))}if(this._opts.iipSupport){let e=new MA(this._opts,this._renderer,this._storage,A);this._handlers.set("iip",e),this._disposeLater(A._core._inputHandler._parser.registerOscHandler(1337,e))}}reset(){this._opts.sixelScrolling=this._defaultOpts.sixelScrolling,this._opts.sixelPaletteLimit=this._defaultOpts.sixelPaletteLimit,this._storage?.reset();for(let A of this._handlers.values())A.reset();return false}get storageLimit(){return this._storage?.getLimit()||-1}set storageLimit(A){this._storage?.setLimit(A),this._opts.storageLimit=A}get storageUsage(){return this._storage?this._storage.getUsage():-1}get showPlaceholder(){return this._opts.showPlaceholder}set showPlaceholder(A){this._opts.showPlaceholder=A,this._renderer?.showPlaceholder(A)}getImageAtBufferCell(A,e){return this._storage?.getImageAtBufferCell(A,e)}extractTileAtBufferCell(A,e){return this._storage?.extractTileAtBufferCell(A,e)}_report(A){this._terminal?._core.coreService.triggerDataEvent(A)}_decset(A){for(let e=0;e<A.length;++e)switch(A[e]){case 80:this._opts.sixelScrolling=false;break}return false}_decrst(A){for(let e=0;e<A.length;++e)switch(A[e]){case 80:this._opts.sixelScrolling=true;break}return false}_da1(A){return A[0]?true:this._opts.sixelSupport?(this._report("\x1B[?62;4;9;22c"),true):false}_xtermGraphicsAttributes(A){if(A.length<2)return true;if(A[0]===1)switch(A[1]){case 1:return this._report(`\x1B[?${A[0]};0;${this._opts.sixelPaletteLimit}S`),true;case 2:this._opts.sixelPaletteLimit=this._defaultOpts.sixelPaletteLimit,this._report(`\x1B[?${A[0]};0;${this._opts.sixelPaletteLimit}S`);for(let e of this._handlers.values())e.reset();return true;case 3:return A.length>2&&!(A[2]instanceof Array)&&A[2]<=z?(this._opts.sixelPaletteLimit=A[2],this._report(`\x1B[?${A[0]};0;${this._opts.sixelPaletteLimit}S`)):this._report(`\x1B[?${A[0]};2S`),true;case 4:return this._report(`\x1B[?${A[0]};0;${z}S`),true;default:return this._report(`\x1B[?${A[0]};2S`),true}if(A[0]===2)switch(A[1]){case 1:let e=this._renderer?.dimensions?.css.canvas.width,t=this._renderer?.dimensions?.css.canvas.height;if(!e||!t){let s=M;e=(this._terminal?.cols||80)*s.width,t=(this._terminal?.rows||24)*s.height}if(e*t<this._opts.pixelLimit)this._report(`\x1B[?${A[0]};0;${e.toFixed(0)};${t.toFixed(0)}S`);else{let s=Math.floor(Math.sqrt(this._opts.pixelLimit));this._report(`\x1B[?${A[0]};0;${s};${s}S`)}return true;case 4:let i=Math.floor(Math.sqrt(this._opts.pixelLimit));return this._report(`\x1B[?${A[0]};0;${i};${i}S`),true;default:return this._report(`\x1B[?${A[0]};2S`),true}return this._report(`\x1B[?${A[0]};1S`),true}};export{HA as ImageAddon};
