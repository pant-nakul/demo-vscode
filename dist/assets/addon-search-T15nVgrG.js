/**
 * Copyright (c) 2014-2024 The xterm.js authors. All rights reserved.
 * @license MIT
 *
 * Copyright (c) 2012-2013, Christopher Jeffrey (MIT License)
 * @license MIT
 *
 * Originally forked from (with the author's permission):
 *   Fabrice Bellard's javascript vt100 for jslinux:
 *   http://bellard.org/jslinux/
 *   Copyright (c) 2011 Fabrice Bellard
 */var fe=class{constructor(){this.listeners=[],this.unexpectedErrorHandler=function(e){setTimeout(()=>{throw e.stack?Z.isErrorNoTelemetry(e)?new Z(e.message+`

`+e.stack):new Error(e.message+`

`+e.stack):e},0)}}addListener(e){return this.listeners.push(e),()=>{this._removeListener(e)}}emit(e){this.listeners.forEach(t=>{t(e)})}_removeListener(e){this.listeners.splice(this.listeners.indexOf(e),1)}setUnexpectedErrorHandler(e){this.unexpectedErrorHandler=e}getUnexpectedErrorHandler(){return this.unexpectedErrorHandler}onUnexpectedError(e){this.unexpectedErrorHandler(e),this.emit(e)}onUnexpectedExternalError(e){this.unexpectedErrorHandler(e)}};var _e=new fe;function $(e){pe(e)||_e.onUnexpectedError(e)}var B="Canceled";function pe(e){return e instanceof ge?true:e instanceof Error&&e.name===B&&e.message===B}var ge=class extends Error{constructor(){super(B),this.name=this.message}};var Z=class U extends Error{constructor(t){super(t),this.name="CodeExpectedError"}static fromError(t){if(t instanceof U)return t;let s=new U;return s.message=t.message,s.stack=t.stack,s}static isErrorNoTelemetry(t){return t.name==="CodeExpectedError"}};function ve(e,t){let s=this,i=false,n;return function(){if(i)return n;if(i=true,t);else n=e.apply(s,arguments);return n}}var me;(e=>{function t(r){return r<0}e.isLessThan=t;function s(r){return r<=0}e.isLessThanOrEqual=s;function i(r){return r>0}e.isGreaterThan=i;function n(r){return r===0}e.isNeitherLessOrGreaterThan=n,e.greaterThan=1,e.lessThan=-1,e.neitherLessOrGreaterThan=0})(me||={});var G;(e=>{function t(d){return d&&typeof d=="object"&&typeof d[Symbol.iterator]=="function"}e.is=t;let s=Object.freeze([]);function i(){return s}e.empty=i;function*n(d){yield d}e.single=n;function r(d){return t(d)?d:n(d)}e.wrap=r;function a(d){return d||s}e.from=a;function*f(d){for(let p=d.length-1;p>=0;p--)yield d[p]}e.reverse=f;function m(d){return!d||d[Symbol.iterator]().next().done===true}e.isEmpty=m;function C(d){return d[Symbol.iterator]().next().value}e.first=C;function E(d,p){let v=0;for(let y of d)if(p(y,v++))return true;return false}e.some=E;function k(d,p){for(let v of d)if(p(v))return v}e.find=k;function*T(d,p){for(let v of d)p(v)&&(yield v)}e.filter=T;function*S(d,p){let v=0;for(let y of d)yield p(y,v++)}e.map=S;function*b(d,p){let v=0;for(let y of d)yield*p(y,v++)}e.flatMap=b;function*w(...d){for(let p of d)yield*p}e.concat=w;function M(d,p,v){let y=v;for(let A of d)y=p(y,A);return y}e.reduce=M;function*x(d,p,v=d.length){for(p<0&&(p+=d.length),v<0?v+=d.length:v>d.length&&(v=d.length);p<v;p++)yield d[p]}e.slice=x;function O(d,p=Number.POSITIVE_INFINITY){let v=[];if(p===0)return[v,d];let y=d[Symbol.iterator]();for(let A=0;A<p;A++){let F=y.next();if(F.done)return[v,e.empty()];v.push(F.value)}return[v,{[Symbol.iterator](){return y}}]}e.consume=O;async function W(d){let p=[];for await(let v of d)p.push(v);return Promise.resolve(p)}e.asyncToArray=W})(G||={});function we(e){return e}function ee(e,t){}function N(e){if(G.is(e)){let t=[];for(let s of e)if(s)try{s.dispose()}catch(i){t.push(i)}if(t.length===1)throw t[0];if(t.length>1)throw new AggregateError(t,"Encountered errors while disposing of store");return Array.isArray(e)?[]:e}else if(e)return e.dispose(),e}function te(...e){let t=J(()=>N(e));return t}function J(e){let t=we({dispose:ve(()=>{e()})});return t}var ie=class se{constructor(){this._toDispose=new Set;this._isDisposed=false}dispose(){this._isDisposed||(this._isDisposed=true,this.clear())}get isDisposed(){return this._isDisposed}clear(){if(this._toDispose.size!==0)try{N(this._toDispose)}finally{this._toDispose.clear()}}add(t){if(!t)return t;if(t===this)throw new Error("Cannot register a disposable on itself!");return this._isDisposed?se.DISABLE_DISPOSED_WARNING||console.warn(new Error("Trying to add a disposable to a DisposableStore that has already been disposed of. The added object will be leaked!").stack):this._toDispose.add(t),t}delete(t){if(t){if(t===this)throw new Error("Cannot dispose a disposable on itself!");this._toDispose.delete(t),t.dispose()}}deleteAndLeak(t){t&&this._toDispose.has(t)&&(this._toDispose.delete(t),ee())}};ie.DISABLE_DISPOSED_WARNING=false;var V=ie;var P=class{constructor(){this._store=new V;ee(this._store)}dispose(){this._store.dispose()}_register(e){if(e===this)throw new Error("Cannot register a disposable on itself!");return this._store.add(e)}};P.None=Object.freeze({dispose(){}});var X=class{constructor(){this._isDisposed=false}get value(){return this._isDisposed?void 0:this._value}set value(e){this._isDisposed||e===this._value||(this._value?.dispose(),this._value=e)}clear(){this.value=void 0}dispose(){this._isDisposed=true,this._value?.dispose(),this._value=void 0}clearAndLeak(){let e=this._value;return this._value=void 0,e}};var Le=globalThis.performance&&typeof globalThis.performance.now=="function";var be=class re{static create(t){return new re(t)}constructor(t){this._now=Le&&t===false?Date.now:globalThis.performance.now.bind(globalThis.performance),this._startTime=this._now(),this._stopTime=-1}stop(){this._stopTime=this._now()}reset(){this._startTime=this._now(),this._stopTime=-1}elapsed(){return this._stopTime!==-1?this._stopTime-this._startTime:this._now()-this._startTime}};var Ce;(e=>{e.None=()=>P.None;function t(c,o){return k(c,()=>{},0,void 0,true,void 0,o)}e.defer=t;function s(c){return(o,h=null,l)=>{let u=false,_;return _=c(g=>{if(!u)return _?_.dispose():u=true,o.call(h,g)},null,l),u&&_.dispose(),_}}e.once=s;function i(c,o,h){return C((l,u=null,_)=>c(g=>l.call(u,o(g)),null,_),h)}e.map=i;function n(c,o,h){return C((l,u=null,_)=>c(g=>{o(g),l.call(u,g)},null,_),h)}e.forEach=n;function r(c,o,h){return C((l,u=null,_)=>c(g=>o(g)&&l.call(u,g),null,_),h)}e.filter=r;function a(c){return c}e.signal=a;function f(...c){return(o,h=null,l)=>{let u=te(...c.map(_=>_(g=>o.call(h,g))));return E(u,l)}}e.any=f;function m(c,o,h,l){let u=h;return i(c,_=>(u=o(u,_),u),l)}e.reduce=m;function C(c,o){let h,l={onWillAddFirstListener(){h=c(u.fire,u)},onDidRemoveLastListener(){h?.dispose()}};let u=new R(l);return o?.add(u),u.event}function E(c,o){return o instanceof Array?o.push(c):o&&o.add(c),c}function k(c,o,h=100,l=false,u=false,_,g){let L,D,I,Q=0,z,ce={leakWarningThreshold:_,onWillAddFirstListener(){L=c(ue=>{Q++,D=o(D,ue),l&&!I&&(Y.fire(D),D=void 0),z=()=>{let de=D;D=void 0,I=void 0,(!l||Q>1)&&Y.fire(de),Q=0},typeof h=="number"?(clearTimeout(I),I=setTimeout(z,h)):I===void 0&&(I=0,queueMicrotask(z))})},onWillRemoveListener(){u&&Q>0&&z?.()},onDidRemoveLastListener(){z=void 0,L.dispose()}};let Y=new R(ce);return g?.add(Y),Y.event}e.debounce=k;function T(c,o=0,h){return e.debounce(c,(l,u)=>l?(l.push(u),l):[u],o,void 0,true,void 0,h)}e.accumulate=T;function S(c,o=(l,u)=>l===u,h){let l=true,u;return r(c,_=>{let g=l||!o(_,u);return l=false,u=_,g},h)}e.latch=S;function b(c,o,h){return[e.filter(c,o,h),e.filter(c,l=>!o(l),h)]}e.split=b;function w(c,o=false,h=[],l){let u=h.slice(),_=c(D=>{u?u.push(D):L.fire(D)});l&&l.add(_);let g=()=>{u?.forEach(D=>L.fire(D)),u=null},L=new R({onWillAddFirstListener(){_||(_=c(D=>L.fire(D)),l&&l.add(_))},onDidAddFirstListener(){u&&(o?setTimeout(g):g())},onDidRemoveLastListener(){_&&_.dispose(),_=null}});return l&&l.add(L),L.event}e.buffer=w;function M(c,o){return(h,l,u)=>{let _=o(new O);return c(function(g){let L=_.evaluate(g);L!==x&&h.call(l,L)},void 0,u)}}e.chain=M;let x=Symbol("HaltChainable");class O{constructor(){this.steps=[]}map(o){return this.steps.push(o),this}forEach(o){return this.steps.push(h=>(o(h),h)),this}filter(o){return this.steps.push(h=>o(h)?h:x),this}reduce(o,h){let l=h;return this.steps.push(u=>(l=o(l,u),l)),this}latch(o=(h,l)=>h===l){let h=true,l;return this.steps.push(u=>{let _=h||!o(u,l);return h=false,l=u,_?u:x}),this}evaluate(o){for(let h of this.steps)if(o=h(o),o===x)break;return o}}function W(c,o,h=l=>l){let l=(...L)=>g.fire(h(...L)),u=()=>c.on(o,l),_=()=>c.removeListener(o,l),g=new R({onWillAddFirstListener:u,onDidRemoveLastListener:_});return g.event}e.fromNodeEventEmitter=W;function d(c,o,h=l=>l){let l=(...L)=>g.fire(h(...L)),u=()=>c.addEventListener(o,l),_=()=>c.removeEventListener(o,l),g=new R({onWillAddFirstListener:u,onDidRemoveLastListener:_});return g.event}e.fromDOMEventEmitter=d;function p(c){return new Promise(o=>s(c)(o))}e.toPromise=p;function v(c){let o=new R;return c.then(h=>{o.fire(h)},()=>{o.fire(void 0)}).finally(()=>{o.dispose()}),o.event}e.fromPromise=v;function y(c,o){return c(h=>o.fire(h))}e.forward=y;function A(c,o,h){return o(h),c(l=>o(l))}e.runAndSubscribe=A;class F{constructor(o,h){this._observable=o;this._counter=0;this._hasChanged=false;let l={onWillAddFirstListener:()=>{o.addObserver(this)},onDidRemoveLastListener:()=>{o.removeObserver(this)}};this.emitter=new R(l),h&&h.add(this.emitter)}beginUpdate(o){this._counter++}handlePossibleChange(o){}handleChange(o,h){this._hasChanged=true}endUpdate(o){this._counter--,this._counter===0&&(this._observable.reportChanges(),this._hasChanged&&(this._hasChanged=false,this.emitter.fire(this._observable.get())))}}function ae(c,o){return new F(c,o).emitter.event}e.fromObservable=ae;function he(c){return(o,h,l)=>{let u=0,_=false,g={beginUpdate(){u++},endUpdate(){u--,u===0&&(c.reportChanges(),_&&(_=false,o.call(h)))},handlePossibleChange(){},handleChange(){_=true}};c.addObserver(g),c.reportChanges();let L={dispose(){c.removeObserver(g)}};return l instanceof V?l.add(L):Array.isArray(l)&&l.push(L),L}}e.fromObservableLight=he})(Ce||={});var q=class K{constructor(t){this.listenerCount=0;this.invocationCount=0;this.elapsedOverall=0;this.durations=[];this.name=`${t}_${K._idPool++}`,K.all.add(this)}start(t){this._stopWatch=new be,this.listenerCount=t}stop(){if(this._stopWatch){let t=this._stopWatch.elapsed();this.durations.push(t),this.elapsedOverall+=t,this.invocationCount+=1,this._stopWatch=void 0}}};q.all=new Set,q._idPool=0;var Se=q;var ye=-1;var ne=class oe{constructor(t,s,i=(oe._idPool++).toString(16).padStart(3,"0")){this._errorHandler=t;this.threshold=s;this.name=i;this._warnCountdown=0}dispose(){this._stacks?.clear()}check(t,s){let i=this.threshold;if(i<=0||s<i)return;this._stacks||(this._stacks=new Map);let n=this._stacks.get(t.value)||0;if(this._stacks.set(t.value,n+1),this._warnCountdown-=1,this._warnCountdown<=0){this._warnCountdown=i*.5;let[r,a]=this.getMostFrequentStack(),f=`[${this.name}] potential listener LEAK detected, having ${s} listeners already. MOST frequent listener (${a}):`;console.warn(f),console.warn(r);let m=new ke(f,r);this._errorHandler(m)}return()=>{let r=this._stacks.get(t.value)||0;this._stacks.set(t.value,r-1)}}getMostFrequentStack(){if(!this._stacks)return;let t,s=0;for(let[i,n]of this._stacks)(!t||s<n)&&(t=[i,n],s=n);return t}};ne._idPool=1;var De=ne;var Ee=class le{constructor(t){this.value=t}static create(){let t=new Error;return new le(t.stack??"")}print(){console.warn(this.value.split(`
`).slice(2).join(`
`))}};var ke=class extends Error{constructor(e,t){super(e),this.name="ListenerLeakError",this.stack=t}};var Te=class extends Error{constructor(e,t){super(e),this.name="ListenerRefusalError",this.stack=t}};var xe=0;var H=class{constructor(e){this.value=e;this.id=xe++}};var Re=2;var Oe;var R=class{constructor(e){this._size=0;this._options=e,this._leakageMon=this._options?.leakWarningThreshold?new De(e?.onListenerError??$,this._options?.leakWarningThreshold??ye):void 0,this._perfMon=this._options?._profName?new Se(this._options._profName):void 0,this._deliveryQueue=this._options?.deliveryQueue}dispose(){if(!this._disposed){if(this._disposed=true,this._deliveryQueue?.current===this&&this._deliveryQueue.reset(),this._listeners){this._listeners=void 0,this._size=0}this._options?.onDidRemoveLastListener?.(),this._leakageMon?.dispose()}}get event(){return this._event??=(e,t,s)=>{if(this._leakageMon&&this._size>this._leakageMon.threshold**2){let a=`[${this._leakageMon.name}] REFUSES to accept new listeners because it exceeded its threshold by far (${this._size} vs ${this._leakageMon.threshold})`;console.warn(a);let f=this._leakageMon.getMostFrequentStack()??["UNKNOWN stack",-1],m=new Te(`${a}. HINT: Stack shows most frequent listener (${f[1]}-times)`,f[0]);return(this._options?.onListenerError||$)(m),P.None}if(this._disposed)return P.None;t&&(e=e.bind(t));let i=new H(e),n;this._leakageMon&&this._size>=Math.ceil(this._leakageMon.threshold*.2)&&(i.stack=Ee.create(),n=this._leakageMon.check(i.stack,this._size+1)),this._listeners?this._listeners instanceof H?(this._deliveryQueue??=new Ae,this._listeners=[this._listeners,i]):this._listeners.push(i):(this._options?.onWillAddFirstListener?.(this),this._listeners=i,this._options?.onDidAddFirstListener?.(this)),this._size++;let r=J(()=>{n?.(),this._removeListener(i)});if(s instanceof V?s.add(r):Array.isArray(s)&&s.push(r),Oe);return r},this._event}_removeListener(e){if(this._options?.onWillRemoveListener?.(this),!this._listeners)return;if(this._size===1){this._listeners=void 0,this._options?.onDidRemoveLastListener?.(this),this._size=0;return}let t=this._listeners,s=t.indexOf(e);if(s===-1)throw console.log("disposed?",this._disposed),console.log("size?",this._size),console.log("arr?",JSON.stringify(this._listeners)),new Error("Attempted to dispose unknown listener");this._size--,t[s]=void 0;let i=this._deliveryQueue.current===this;if(this._size*Re<=t.length){let n=0;for(let r=0;r<t.length;r++)t[r]?t[n++]=t[r]:i&&(this._deliveryQueue.end--,n<this._deliveryQueue.i&&this._deliveryQueue.i--);t.length=n}}_deliver(e,t){if(!e)return;let s=this._options?.onListenerError||$;if(!s){e.value(t);return}try{e.value(t)}catch(i){s(i)}}_deliverQueue(e){let t=e.current._listeners;for(;e.i<e.end;)this._deliver(t[e.i++],e.value);e.reset()}fire(e){if(this._deliveryQueue?.current&&(this._deliverQueue(this._deliveryQueue),this._perfMon?.stop()),this._perfMon?.start(this._size),this._listeners)if(this._listeners instanceof H)this._deliver(this._listeners,e);else{let t=this._deliveryQueue;t.enqueue(this,e,this._listeners.length),this._deliverQueue(t)}this._perfMon?.stop()}hasListeners(){return this._size>0}};var Ae=class{constructor(){this.i=-1;this.end=0}enqueue(e,t,s){this.i=0,this.end=s,this.current=e,this.value=t}reset(){this.i=this.end,this.current=void 0,this.value=void 0}};var j=" ~!@#$%^&*()+`-=[]{}|\\;:\"',./<>?";var Ie=15*1e3;var Me=1e3;var We=class extends P{constructor(e){super();this._highlightedLines=new Set;this._highlightDecorations=[];this._selectedDecoration=this._register(new X);this._linesCacheTimeoutId=0;this._linesCacheDisposables=new X;this._onDidChangeResults=this._register(new R);this.onDidChangeResults=this._onDidChangeResults.event;this._highlightLimit=e?.highlightLimit??Me}activate(e){this._terminal=e,this._register(this._terminal.onWriteParsed(()=>this._updateMatches())),this._register(this._terminal.onResize(()=>this._updateMatches())),this._register(J(()=>this.clearDecorations()))}_updateMatches(){this._highlightTimeout&&window.clearTimeout(this._highlightTimeout),this._cachedSearchTerm&&this._lastSearchOptions?.decorations&&(this._highlightTimeout=setTimeout(()=>{let e=this._cachedSearchTerm;this._cachedSearchTerm=void 0,this.findPrevious(e,{...this._lastSearchOptions,incremental:true,noScroll:true})},200))}clearDecorations(e){this._selectedDecoration.clear(),N(this._highlightDecorations),this._highlightDecorations=[],this._highlightedLines.clear(),e||(this._cachedSearchTerm=void 0)}clearActiveDecoration(){this._selectedDecoration.clear()}findNext(e,t){if(!this._terminal)throw new Error("Cannot use addon until it has been loaded");let s=this._lastSearchOptions?this._didOptionsChange(this._lastSearchOptions,t):true;this._lastSearchOptions=t,t?.decorations&&(this._cachedSearchTerm===void 0||e!==this._cachedSearchTerm||s)&&this._highlightAllMatches(e,t);let i=this._findNextAndSelect(e,t);return this._fireResults(t),this._cachedSearchTerm=e,i}_highlightAllMatches(e,t){if(!this._terminal)throw new Error("Cannot use addon until it has been loaded");if(!e||e.length===0){this.clearDecorations();return}t=t||{},this.clearDecorations(true);let s=[],i,n=this._find(e,0,0,t);for(;n&&(i?.row!==n.row||i?.col!==n.col)&&!(s.length>=this._highlightLimit);)i=n,s.push(i),n=this._find(e,i.col+i.term.length>=this._terminal.cols?i.row+1:i.row,i.col+i.term.length>=this._terminal.cols?0:i.col+1,t);for(let r of s){let a=this._createResultDecoration(r,t.decorations);a&&(this._highlightedLines.add(a.marker.line),this._highlightDecorations.push({decoration:a,match:r,dispose(){a.dispose()}}))}}_find(e,t,s,i){if(!this._terminal||!e||e.length===0){this._terminal?.clearSelection(),this.clearDecorations();return}if(s>this._terminal.cols)throw new Error(`Invalid col: ${s} to search in terminal of ${this._terminal.cols} cols`);let n;this._initLinesCache();let r={startRow:t,startCol:s};if(n=this._findInLine(e,r,i),!n)for(let a=t+1;a<this._terminal.buffer.active.baseY+this._terminal.rows&&(r.startRow=a,r.startCol=0,n=this._findInLine(e,r,i),!n);a++);return n}_findNextAndSelect(e,t){if(!this._terminal||!e||e.length===0)return this._terminal?.clearSelection(),this.clearDecorations(),false;let s=this._terminal.getSelectionPosition();this._terminal.clearSelection();let i=0,n=0;s&&(this._cachedSearchTerm===e?(i=s.end.x,n=s.end.y):(i=s.start.x,n=s.start.y)),this._initLinesCache();let r={startRow:n,startCol:i},a=this._findInLine(e,r,t);if(!a)for(let f=n+1;f<this._terminal.buffer.active.baseY+this._terminal.rows&&(r.startRow=f,r.startCol=0,a=this._findInLine(e,r,t),!a);f++);if(!a&&n!==0)for(let f=0;f<n&&(r.startRow=f,r.startCol=0,a=this._findInLine(e,r,t),!a);f++);return!a&&s&&(r.startRow=s.start.y,r.startCol=0,a=this._findInLine(e,r,t)),this._selectResult(a,t?.decorations,t?.noScroll)}findPrevious(e,t){if(!this._terminal)throw new Error("Cannot use addon until it has been loaded");let s=this._lastSearchOptions?this._didOptionsChange(this._lastSearchOptions,t):true;this._lastSearchOptions=t,t?.decorations&&(this._cachedSearchTerm===void 0||e!==this._cachedSearchTerm||s)&&this._highlightAllMatches(e,t);let i=this._findPreviousAndSelect(e,t);return this._fireResults(t),this._cachedSearchTerm=e,i}_didOptionsChange(e,t){return t?e.caseSensitive!==t.caseSensitive||e.regex!==t.regex||e.wholeWord!==t.wholeWord:false}_fireResults(e){if(e?.decorations){let t=-1;if(this._selectedDecoration.value){let s=this._selectedDecoration.value.match;for(let i=0;i<this._highlightDecorations.length;i++){let n=this._highlightDecorations[i].match;if(n.row===s.row&&n.col===s.col&&n.size===s.size){t=i;break}}}this._onDidChangeResults.fire({resultIndex:t,resultCount:this._highlightDecorations.length})}}_findPreviousAndSelect(e,t){if(!this._terminal)throw new Error("Cannot use addon until it has been loaded");if(!this._terminal||!e||e.length===0)return this._terminal?.clearSelection(),this.clearDecorations(),false;let s=this._terminal.getSelectionPosition();this._terminal.clearSelection();let i=this._terminal.buffer.active.baseY+this._terminal.rows-1,n=this._terminal.cols,r=true;this._initLinesCache();let a={startRow:i,startCol:n},f;if(s&&(a.startRow=i=s.start.y,a.startCol=n=s.start.x,this._cachedSearchTerm!==e&&(f=this._findInLine(e,a,t,false),f||(a.startRow=i=s.end.y,a.startCol=n=s.end.x))),f||(f=this._findInLine(e,a,t,r)),!f){a.startCol=Math.max(a.startCol,this._terminal.cols);for(let m=i-1;m>=0&&(a.startRow=m,f=this._findInLine(e,a,t,r),!f);m--);}if(!f&&i!==this._terminal.buffer.active.baseY+this._terminal.rows-1)for(let m=this._terminal.buffer.active.baseY+this._terminal.rows-1;m>=i&&(a.startRow=m,f=this._findInLine(e,a,t,r),!f);m--);return this._selectResult(f,t?.decorations,t?.noScroll)}_initLinesCache(){let e=this._terminal;this._linesCache||(this._linesCache=new Array(e.buffer.active.length),this._linesCacheDisposables.value=te(e.onLineFeed(()=>this._destroyLinesCache()),e.onCursorMove(()=>this._destroyLinesCache()),e.onResize(()=>this._destroyLinesCache()))),window.clearTimeout(this._linesCacheTimeoutId),this._linesCacheTimeoutId=window.setTimeout(()=>this._destroyLinesCache(),Ie)}_destroyLinesCache(){this._linesCache=void 0,this._linesCacheDisposables.clear(),this._linesCacheTimeoutId&&(window.clearTimeout(this._linesCacheTimeoutId),this._linesCacheTimeoutId=0)}_isWholeWord(e,t,s){return(e===0||j.includes(t[e-1]))&&(e+s.length===t.length||j.includes(t[e+s.length]))}_findInLine(e,t,s={},i=false){let n=this._terminal,r=t.startRow,a=t.startCol;if(n.buffer.active.getLine(r)?.isWrapped){if(i){t.startCol+=n.cols;return}return t.startRow--,t.startCol+=n.cols,this._findInLine(e,t,s)}let f=this._linesCache?.[r];f||(f=this._translateBufferLineToStringWithWrap(r,true),this._linesCache&&(this._linesCache[r]=f));let[m,C]=f,E=this._bufferColsToStringOffset(r,a),k=s.caseSensitive?e:e.toLowerCase(),T=s.caseSensitive?m:m.toLowerCase(),S=-1;if(s.regex){let b=RegExp(k,"g"),w;if(i)for(;w=b.exec(T.slice(0,E));)S=b.lastIndex-w[0].length,e=w[0],b.lastIndex-=e.length-1;else w=b.exec(T.slice(E)),w&&w[0].length>0&&(S=E+(b.lastIndex-w[0].length),e=w[0])}else i?E-k.length>=0&&(S=T.lastIndexOf(k,E-k.length)):S=T.indexOf(k,E);if(S>=0){if(s.wholeWord&&!this._isWholeWord(S,T,e))return;let b=0;for(;b<C.length-1&&S>=C[b+1];)b++;let w=b;for(;w<C.length-1&&S+e.length>=C[w+1];)w++;let M=S-C[b],x=S+e.length-C[w],O=this._stringLengthToBufferSize(r+b,M),W=this._stringLengthToBufferSize(r+w,x)-O+n.cols*(w-b);return{term:e,col:O,row:r+b,size:W}}}_stringLengthToBufferSize(e,t){let s=this._terminal.buffer.active.getLine(e);if(!s)return 0;for(let i=0;i<t;i++){let n=s.getCell(i);if(!n)break;let r=n.getChars();r.length>1&&(t-=r.length-1);let a=s.getCell(i+1);a&&a.getWidth()===0&&t++}return t}_bufferColsToStringOffset(e,t){let s=this._terminal,i=e,n=0,r=s.buffer.active.getLine(i);for(;t>0&&r;){for(let a=0;a<t&&a<s.cols;a++){let f=r.getCell(a);if(!f)break;f.getWidth()&&(n+=f.getCode()===0?1:f.getChars().length)}if(i++,r=s.buffer.active.getLine(i),r&&!r.isWrapped)break;t-=s.cols}return n}_translateBufferLineToStringWithWrap(e,t){let s=this._terminal,i=[],n=[0],r=s.buffer.active.getLine(e);for(;r;){let a=s.buffer.active.getLine(e+1),f=a?a.isWrapped:false,m=r.translateToString(!f&&t);if(f&&a){let C=r.getCell(r.length-1);C&&C.getCode()===0&&C.getWidth()===1&&a.getCell(0)?.getWidth()===2&&(m=m.slice(0,-1))}if(i.push(m),f)n.push(n[n.length-1]+m.length);else break;e++,r=a}return[i.join(""),n]}_selectResult(e,t,s){let i=this._terminal;if(this._selectedDecoration.clear(),!e)return i.clearSelection(),false;if(i.select(e.col,e.row,e.size),t){let n=i.registerMarker(-i.buffer.active.baseY-i.buffer.active.cursorY+e.row);if(n){let r=i.registerDecoration({marker:n,x:e.col,width:e.size,backgroundColor:t.activeMatchBackground,layer:"top",overviewRulerOptions:{color:t.activeMatchColorOverviewRuler}});if(r){let a=[];a.push(n),a.push(r.onRender(f=>this._applyStyles(f,t.activeMatchBorder,true))),a.push(r.onDispose(()=>N(a))),this._selectedDecoration.value={decoration:r,match:e,dispose(){r.dispose()}}}}}if(!s&&(e.row>=i.buffer.active.viewportY+i.rows||e.row<i.buffer.active.viewportY)){let n=e.row-i.buffer.active.viewportY;n-=Math.floor(i.rows/2),i.scrollLines(n)}return true}_applyStyles(e,t,s){e.classList.contains("xterm-find-result-decoration")||(e.classList.add("xterm-find-result-decoration"),t&&(e.style.outline=`1px solid ${t}`)),s&&e.classList.add("xterm-find-active-result-decoration")}_createResultDecoration(e,t){let s=this._terminal,i=s.registerMarker(-s.buffer.active.baseY-s.buffer.active.cursorY+e.row);if(!i)return;let n=s.registerDecoration({marker:i,x:e.col,width:e.size,backgroundColor:t.matchBackground,overviewRulerOptions:this._highlightedLines.has(i.line)?void 0:{color:t.matchOverviewRuler,position:"center"}});if(n){let r=[];r.push(i),r.push(n.onRender(a=>this._applyStyles(a,t.matchBorder,false))),r.push(n.onDispose(()=>N(r)))}return n}};export{We as SearchAddon};
