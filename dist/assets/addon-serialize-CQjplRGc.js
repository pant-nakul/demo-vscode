/**
 * Copyright (c) 2014-2024 The xterm.js authors. All rights reserved.
 * @license MIT
 *
 * Copyright (c) 2012-2013, Christopher Jeffrey (MIT License)
 * @license MIT
 *
 * Originally forked from (with the author's permission):
 *   Fabrice Bellard's javascript vt100 for jslinux:
 *   http://bellard.org/jslinux/
 *   Copyright (c) 2011 Fabrice Bellard
 */var d=0;var p=0;var b=0;var f=0;var m;(t=>{function r(s,l,i,a){return a!==void 0?`#${y(s)}${y(l)}${y(i)}${y(a)}`:`#${y(s)}${y(l)}${y(i)}`}t.toCss=r;function e(s,l,i,a=255){return(s<<24|l<<16|i<<8|a)>>>0}t.toRgba=e;function n(s,l,i,a){return{css:t.toCss(s,l,i,a),rgba:t.toRgba(s,l,i,a)}}t.toColor=n})(m||={});var F;(t=>{function r(u,o){if(f=(o.rgba&255)/255,f===1)return{css:o.css,rgba:o.rgba};let g=o.rgba>>24&255,_=o.rgba>>16&255,C=o.rgba>>8&255,h=u.rgba>>24&255,c=u.rgba>>16&255,x=u.rgba>>8&255;d=h+Math.round((g-h)*f),p=c+Math.round((_-c)*f),b=x+Math.round((C-x)*f);let M=m.toCss(d,p,b),$=m.toRgba(d,p,b);return{css:M,rgba:$}}t.blend=r;function e(u){return(u.rgba&255)===255}t.isOpaque=e;function n(u,o,g){let _=S.ensureContrastRatio(u.rgba,o.rgba,g);if(_)return m.toColor(_>>24&255,_>>16&255,_>>8&255)}t.ensureContrastRatio=n;function s(u){let o=(u.rgba|255)>>>0;return[d,p,b]=S.toChannels(o),{css:m.toCss(d,p,b),rgba:o}}t.opaque=s;function l(u,o){return f=Math.round(o*255),[d,p,b]=S.toChannels(u.rgba),{css:m.toCss(d,p,b,f),rgba:m.toRgba(d,p,b,f)}}t.opacity=l;function i(u,o){return f=u.rgba&255,l(u,f*o/255)}t.multiplyOpacity=i;function a(u){return[u.rgba>>24&255,u.rgba>>16&255,u.rgba>>8&255]}t.toColorRGB=a})(F||={});var w;(t=>{let r,e;try{let s=document.createElement("canvas");s.width=1,s.height=1;let l=s.getContext("2d",{willReadFrequently:true});l&&(r=l,r.globalCompositeOperation="copy",e=r.createLinearGradient(0,0,1,1))}catch{}function n(s){if(s.match(/#[\da-f]{3,8}/i))switch(s.length){case 4:return d=parseInt(s.slice(1,2).repeat(2),16),p=parseInt(s.slice(2,3).repeat(2),16),b=parseInt(s.slice(3,4).repeat(2),16),m.toColor(d,p,b);case 5:return d=parseInt(s.slice(1,2).repeat(2),16),p=parseInt(s.slice(2,3).repeat(2),16),b=parseInt(s.slice(3,4).repeat(2),16),f=parseInt(s.slice(4,5).repeat(2),16),m.toColor(d,p,b,f);case 7:return{css:s,rgba:(parseInt(s.slice(1),16)<<8|255)>>>0};case 9:return{css:s,rgba:parseInt(s.slice(1),16)>>>0}}let l=s.match(/rgba?\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*(,\s*(0|1|\d?\.(\d+))\s*)?\)/);if(l)return d=parseInt(l[1]),p=parseInt(l[2]),b=parseInt(l[3]),f=Math.round((l[5]===void 0?1:parseFloat(l[5]))*255),m.toColor(d,p,b,f);if(!r||!e)throw new Error("css.toColor: Unsupported css format");if(r.fillStyle=e,r.fillStyle=s,typeof r.fillStyle!="string")throw new Error("css.toColor: Unsupported css format");if(r.fillRect(0,0,1,1),[d,p,b,f]=r.getImageData(0,0,1,1).data,f!==255)throw new Error("css.toColor: Unsupported css format");return{rgba:m.toRgba(d,p,b,f),css:s}}t.toColor=n})(w||={});var B;(t=>{function r(n){return e(n>>16&255,n>>8&255,n&255)}t.relativeLuminance=r;function e(n,s,l){let i=n/255,a=s/255,u=l/255,o=i<=.03928?i/12.92:Math.pow((i+.055)/1.055,2.4),g=a<=.03928?a/12.92:Math.pow((a+.055)/1.055,2.4),_=u<=.03928?u/12.92:Math.pow((u+.055)/1.055,2.4);return o*.2126+g*.7152+_*.0722}t.relativeLuminance2=e})(B||={});var S;(t=>{function r(i,a){if(f=(a&255)/255,f===1)return a;let u=a>>24&255,o=a>>16&255,g=a>>8&255,_=i>>24&255,C=i>>16&255,h=i>>8&255;return d=_+Math.round((u-_)*f),p=C+Math.round((o-C)*f),b=h+Math.round((g-h)*f),m.toRgba(d,p,b)}t.blend=r;function e(i,a,u){let o=B.relativeLuminance(i>>8),g=B.relativeLuminance(a>>8);if(R(o,g)<u){if(g<o){let h=n(i,a,u),c=R(o,B.relativeLuminance(h>>8));if(c<u){let x=s(i,a,u),M=R(o,B.relativeLuminance(x>>8));return c>M?h:x}return h}let _=s(i,a,u),C=R(o,B.relativeLuminance(_>>8));if(C<u){let h=n(i,a,u),c=R(o,B.relativeLuminance(h>>8));return C>c?_:h}return _}}t.ensureContrastRatio=e;function n(i,a,u){let o=i>>24&255,g=i>>16&255,_=i>>8&255,C=a>>24&255,h=a>>16&255,c=a>>8&255,x=R(B.relativeLuminance2(C,h,c),B.relativeLuminance2(o,g,_));for(;x<u&&(C>0||h>0||c>0);)C-=Math.max(0,Math.ceil(C*.1)),h-=Math.max(0,Math.ceil(h*.1)),c-=Math.max(0,Math.ceil(c*.1)),x=R(B.relativeLuminance2(C,h,c),B.relativeLuminance2(o,g,_));return(C<<24|h<<16|c<<8|255)>>>0}t.reduceLuminance=n;function s(i,a,u){let o=i>>24&255,g=i>>16&255,_=i>>8&255,C=a>>24&255,h=a>>16&255,c=a>>8&255,x=R(B.relativeLuminance2(C,h,c),B.relativeLuminance2(o,g,_));for(;x<u&&(C<255||h<255||c<255);)C=Math.min(255,C+Math.ceil((255-C)*.1)),h=Math.min(255,h+Math.ceil((255-h)*.1)),c=Math.min(255,c+Math.ceil((255-c)*.1)),x=R(B.relativeLuminance2(C,h,c),B.relativeLuminance2(o,g,_));return(C<<24|h<<16|c<<8|255)>>>0}t.increaseLuminance=s;function l(i){return[i>>24&255,i>>16&255,i>>8&255,i&255]}t.toChannels=l})(S||={});function y(t){let r=t.toString(16);return r.length<2?"0"+r:r}function R(t,r){return t<r?(r+.05)/(t+.05):(t+.05)/(r+.05)}var A=Object.freeze((()=>{let t=[w.toColor("#2e3436"),w.toColor("#cc0000"),w.toColor("#4e9a06"),w.toColor("#c4a000"),w.toColor("#3465a4"),w.toColor("#75507b"),w.toColor("#06989a"),w.toColor("#d3d7cf"),w.toColor("#555753"),w.toColor("#ef2929"),w.toColor("#8ae234"),w.toColor("#fce94f"),w.toColor("#729fcf"),w.toColor("#ad7fa8"),w.toColor("#34e2e2"),w.toColor("#eeeeec")],r=[0,95,135,175,215,255];for(let e=0;e<216;e++){let n=r[e/36%6|0],s=r[e/6%6|0],l=r[e%6];t.push({css:m.toCss(n,s,l),rgba:m.toRgba(n,s,l)})}for(let e=0;e<24;e++){let n=8+e*10;t.push({css:m.toCss(n,n,n),rgba:m.toRgba(n,n,n)})}return t})());function k(t,r,e){return Math.max(r,Math.min(t,e))}function D(t){switch(t){case"&":return"&amp;";case"<":return"&lt;"}return t}var I=class{constructor(t){this._buffer=t}serialize(t,r){let e=this._buffer.getNullCell(),n=this._buffer.getNullCell(),s=e,l=t.start.y,i=t.end.y,a=t.start.x,u=t.end.x;this._beforeSerialize(i-l,l,i);for(let o=l;o<=i;o++){let g=this._buffer.getLine(o);if(g){let _=o===t.start.y?a:0,C=o===t.end.y?u:g.length;for(let h=_;h<C;h++){let c=g.getCell(h,s===e?n:e);if(!c){console.warn(`Can't get cell at row=${o}, col=${h}`);continue}this._nextCell(c,s,o,h),s=c}}this._rowEnd(o,o===i)}return this._afterSerialize(),this._serializeString(r)}_nextCell(t,r,e,n){}_rowEnd(t,r){}_beforeSerialize(t,r,e){}_afterSerialize(){}_serializeString(t){return""}};function L(t,r){return t.getFgColorMode()===r.getFgColorMode()&&t.getFgColor()===r.getFgColor()}function v(t,r){return t.getBgColorMode()===r.getBgColorMode()&&t.getBgColor()===r.getBgColor()}function z(t,r){return t.isInverse()===r.isInverse()&&t.isBold()===r.isBold()&&t.isUnderline()===r.isUnderline()&&t.isOverline()===r.isOverline()&&t.isBlink()===r.isBlink()&&t.isInvisible()===r.isInvisible()&&t.isItalic()===r.isItalic()&&t.isDim()===r.isDim()&&t.isStrikethrough()===r.isStrikethrough()}var E=class extends I{constructor(t,r){super(t);this._terminal=r;this._rowIndex=0;this._allRows=new Array;this._allRowSeparators=new Array;this._currentRow="";this._nullCellCount=0;this._cursorStyle=this._buffer.getNullCell();this._cursorStyleRow=0;this._cursorStyleCol=0;this._backgroundCell=this._buffer.getNullCell();this._firstRow=0;this._lastCursorRow=0;this._lastCursorCol=0;this._lastContentCursorRow=0;this._lastContentCursorCol=0;this._thisRowLastChar=this._buffer.getNullCell();this._thisRowLastSecondChar=this._buffer.getNullCell();this._nextRowFirstChar=this._buffer.getNullCell()}_beforeSerialize(t,r,e){this._allRows=new Array(t),this._lastContentCursorRow=r,this._lastCursorRow=r,this._firstRow=r}_rowEnd(t,r){this._nullCellCount>0&&!v(this._cursorStyle,this._backgroundCell)&&(this._currentRow+=`\x1B[${this._nullCellCount}X`);let e="";if(!r){t-this._firstRow>=this._terminal.rows&&this._buffer.getLine(this._cursorStyleRow)?.getCell(this._cursorStyleCol,this._backgroundCell);let n=this._buffer.getLine(t),s=this._buffer.getLine(t+1);if(!s.isWrapped)e=`\r
`,this._lastCursorRow=t+1,this._lastCursorCol=0;else{e="";let l=n.getCell(n.length-1,this._thisRowLastChar),i=n.getCell(n.length-2,this._thisRowLastSecondChar),a=s.getCell(0,this._nextRowFirstChar),u=a.getWidth()>1,o=false;(a.getChars()&&u?this._nullCellCount<=1:this._nullCellCount<=0)&&((l.getChars()||l.getWidth()===0)&&v(l,a)&&(o=true),u&&(i.getChars()||i.getWidth()===0)&&v(l,a)&&v(i,a)&&(o=true)),o||(e="-".repeat(this._nullCellCount+1),e+="\x1B[1D\x1B[1X",this._nullCellCount>0&&(e+="\x1B[A",e+=`\x1B[${n.length-this._nullCellCount}C`,e+=`\x1B[${this._nullCellCount}X`,e+=`\x1B[${n.length-this._nullCellCount}D`,e+="\x1B[B"),this._lastContentCursorRow=t+1,this._lastContentCursorCol=0,this._lastCursorRow=t+1,this._lastCursorCol=0)}}this._allRows[this._rowIndex]=this._currentRow,this._allRowSeparators[this._rowIndex++]=e,this._currentRow="",this._nullCellCount=0}_diffStyle(t,r){let e=[],n=!L(t,r),s=!v(t,r),l=!z(t,r);if(n||s||l)if(t.isAttributeDefault())r.isAttributeDefault()||e.push(0);else{if(n){let i=t.getFgColor();t.isFgRGB()?e.push(38,2,i>>>16&255,i>>>8&255,i&255):t.isFgPalette()?i>=16?e.push(38,5,i):e.push(i&8?90+(i&7):30+(i&7)):e.push(39)}if(s){let i=t.getBgColor();t.isBgRGB()?e.push(48,2,i>>>16&255,i>>>8&255,i&255):t.isBgPalette()?i>=16?e.push(48,5,i):e.push(i&8?100+(i&7):40+(i&7)):e.push(49)}l&&(t.isInverse()!==r.isInverse()&&e.push(t.isInverse()?7:27),t.isBold()!==r.isBold()&&e.push(t.isBold()?1:22),t.isUnderline()!==r.isUnderline()&&e.push(t.isUnderline()?4:24),t.isOverline()!==r.isOverline()&&e.push(t.isOverline()?53:55),t.isBlink()!==r.isBlink()&&e.push(t.isBlink()?5:25),t.isInvisible()!==r.isInvisible()&&e.push(t.isInvisible()?8:28),t.isItalic()!==r.isItalic()&&e.push(t.isItalic()?3:23),t.isDim()!==r.isDim()&&e.push(t.isDim()?2:22),t.isStrikethrough()!==r.isStrikethrough()&&e.push(t.isStrikethrough()?9:29))}return e}_nextCell(t,r,e,n){if(t.getWidth()===0)return;let s=t.getChars()==="",l=this._diffStyle(t,this._cursorStyle);if(s?!v(this._cursorStyle,t):l.length>0){this._nullCellCount>0&&(v(this._cursorStyle,this._backgroundCell)||(this._currentRow+=`\x1B[${this._nullCellCount}X`),this._currentRow+=`\x1B[${this._nullCellCount}C`,this._nullCellCount=0),this._lastContentCursorRow=this._lastCursorRow=e,this._lastContentCursorCol=this._lastCursorCol=n,this._currentRow+=`\x1B[${l.join(";")}m`;let i=this._buffer.getLine(e);i!==void 0&&(i.getCell(n,this._cursorStyle),this._cursorStyleRow=e,this._cursorStyleCol=n)}s?this._nullCellCount+=t.getWidth():(this._nullCellCount>0&&(v(this._cursorStyle,this._backgroundCell)?this._currentRow+=`\x1B[${this._nullCellCount}C`:(this._currentRow+=`\x1B[${this._nullCellCount}X`,this._currentRow+=`\x1B[${this._nullCellCount}C`),this._nullCellCount=0),this._currentRow+=t.getChars(),this._lastContentCursorRow=this._lastCursorRow=e,this._lastContentCursorCol=this._lastCursorCol=n+t.getWidth())}_serializeString(t){let r=this._allRows.length;this._buffer.length-this._firstRow<=this._terminal.rows&&(r=this._lastContentCursorRow+1-this._firstRow,this._lastCursorCol=this._lastContentCursorCol,this._lastCursorRow=this._lastContentCursorRow);let e="";for(let l=0;l<r;l++)e+=this._allRows[l],l+1<r&&(e+=this._allRowSeparators[l]);if(!t){let l=this._buffer.baseY+this._buffer.cursorY,i=this._buffer.cursorX,a=l!==this._lastCursorRow||i!==this._lastCursorCol,u=o=>{o>0?e+=`\x1B[${o}C`:o<0&&(e+=`\x1B[${-o}D`)};a&&((o=>{o>0?e+=`\x1B[${o}B`:o<0&&(e+=`\x1B[${-o}A`)})(l-this._lastCursorRow),u(i-this._lastCursorCol))}let n=this._terminal._core._inputHandler._curAttrData,s=this._diffStyle(n,this._cursorStyle);return s.length>0&&(e+=`\x1B[${s.join(";")}m`),e}};var H=class{activate(t){this._terminal=t}_serializeBufferByScrollback(t,r,e){let n=r.length,s=e===void 0?n:k(e+t.rows,0,n);return this._serializeBufferByRange(t,r,{start:n-s,end:n-1},false)}_serializeBufferByRange(t,r,e,n){return new E(r,t).serialize({start:{x:0,y:typeof e.start=="number"?e.start:e.start.line},end:{x:t.cols,y:typeof e.end=="number"?e.end:e.end.line}},n)}_serializeBufferAsHTML(t,r){let e=t.buffer.active,n=new O(e,t,r);if(!(r.onlySelection??false)){let l=e.length,i=r.scrollback,a=i===void 0?l:k(i+t.rows,0,l);return n.serialize({start:{x:0,y:l-a},end:{x:t.cols,y:l-1}})}let s=this._terminal?.getSelectionPosition();return s!==void 0?n.serialize({start:{x:s.start.x,y:s.start.y},end:{x:s.end.x,y:s.end.y}}):""}_serializeModes(t){let r="",e=t.modes;if(e.applicationCursorKeysMode&&(r+="\x1B[?1h"),e.applicationKeypadMode&&(r+="\x1B[?66h"),e.bracketedPasteMode&&(r+="\x1B[?2004h"),e.insertMode&&(r+="\x1B[4h"),e.originMode&&(r+="\x1B[?6h"),e.reverseWraparoundMode&&(r+="\x1B[?45h"),e.sendFocusMode&&(r+="\x1B[?1004h"),e.wraparoundMode===false&&(r+="\x1B[?7l"),e.mouseTrackingMode!=="none")switch(e.mouseTrackingMode){case"x10":r+="\x1B[?9h";break;case"vt200":r+="\x1B[?1000h";break;case"drag":r+="\x1B[?1002h";break;case"any":r+="\x1B[?1003h";break}return r}serialize(t){if(!this._terminal)throw new Error("Cannot use addon until it has been loaded");let r=t?.range?this._serializeBufferByRange(this._terminal,this._terminal.buffer.normal,t.range,true):this._serializeBufferByScrollback(this._terminal,this._terminal.buffer.normal,t?.scrollback);if(!t?.excludeAltBuffer&&this._terminal.buffer.active.type==="alternate"){let e=this._serializeBufferByScrollback(this._terminal,this._terminal.buffer.alternate,void 0);r+=`\x1B[?1049h\x1B[H${e}`}return t?.excludeModes||(r+=this._serializeModes(this._terminal)),r}serializeAsHTML(t){if(!this._terminal)throw new Error("Cannot use addon until it has been loaded");return this._serializeBufferAsHTML(this._terminal,t||{})}dispose(){}};var O=class extends I{constructor(t,r,e){super(t);this._terminal=r;this._options=e;this._currentRow="";this._htmlContent="";r._core._themeService?this._ansiColors=r._core._themeService.colors.ansi:this._ansiColors=A}_padStart(t,r,e){return r=r>>0,e=e??" ",t.length>r?t:(r-=t.length,r>e.length&&(e+=e.repeat(r/e.length)),e.slice(0,r)+t)}_beforeSerialize(t,r,e){this._htmlContent+="<html><body><!--StartFragment--><pre>";let n="#000000",s="#ffffff";(this._options.includeGlobalBackground??false)&&(n=this._terminal.options.theme?.foreground??"#ffffff",s=this._terminal.options.theme?.background??"#000000");let l=[];l.push("color: "+n+";"),l.push("background-color: "+s+";"),l.push("font-family: "+this._terminal.options.fontFamily+";"),l.push("font-size: "+this._terminal.options.fontSize+"px;"),this._htmlContent+="<div style='"+l.join(" ")+"'>"}_afterSerialize(){this._htmlContent+="</div>",this._htmlContent+="</pre><!--EndFragment--></body></html>"}_rowEnd(t,r){this._htmlContent+="<div><span>"+this._currentRow+"</span></div>",this._currentRow=""}_getHexColor(t,r){let e=r?t.getFgColor():t.getBgColor();if(r?t.isFgRGB():t.isBgRGB())return"#"+[e>>16&255,e>>8&255,e&255].map(n=>this._padStart(n.toString(16),2,"0")).join("");if(r?t.isFgPalette():t.isBgPalette())return this._ansiColors[e].css}_diffStyle(t,r){let e=[],n=!L(t,r),s=!v(t,r),l=!z(t,r);if(n||s||l){let i=this._getHexColor(t,true);i&&e.push("color: "+i+";");let a=this._getHexColor(t,false);return a&&e.push("background-color: "+a+";"),t.isInverse()&&e.push("color: #000000; background-color: #BFBFBF;"),t.isBold()&&e.push("font-weight: bold;"),t.isUnderline()&&t.isOverline()?e.push("text-decoration: overline underline;"):t.isUnderline()?e.push("text-decoration: underline;"):t.isOverline()&&e.push("text-decoration: overline;"),t.isBlink()&&e.push("text-decoration: blink;"),t.isInvisible()&&e.push("visibility: hidden;"),t.isItalic()&&e.push("font-style: italic;"),t.isDim()&&e.push("opacity: 0.5;"),t.isStrikethrough()&&e.push("text-decoration: line-through;"),e}}_nextCell(t,r,e,n){if(t.getWidth()===0)return;let s=t.getChars()==="",l=this._diffStyle(t,r);l&&(this._currentRow+=l.length===0?"</span><span>":"</span><span style='"+l.join(" ")+"'>"),s?this._currentRow+=" ":this._currentRow+=D(t.getChars())}_serializeString(){return this._htmlContent}};export{O as HTMLSerializeHandler,H as SerializeAddon};
